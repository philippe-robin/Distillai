<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DistillAI v2 ‚Äî Conception de Colonnes √† Distiller</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öóÔ∏è</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{--bg:#0a0e1a;--bg2:#111827;--card:#1a2035;--inp:#0d1220;--acc:#f59e0b;--accL:#fbbf24;--accD:#d97706;--t1:#f1f5f9;--t2:#94a3b8;--t3:#64748b;--brd:#1e293b;--ok:#10b981;--warn:#f59e0b;--err:#ef4444;--info:#3b82f6}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 0%,rgba(245,158,11,.08)0%,transparent 50%),radial-gradient(ellipse at 80% 100%,rgba(59,130,246,.05)0%,transparent 50%);pointer-events:none;z-index:0}
.header{position:sticky;top:0;z-index:100;background:rgba(10,14,26,.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--brd);padding:.8rem 2rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem}
.logo{display:flex;align-items:center;gap:.6rem}
.logo-icon{width:38px;height:38px;background:linear-gradient(135deg,var(--acc),var(--accD));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem}
.logo-text{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:900;background:linear-gradient(135deg,var(--accL),var(--acc));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-sub{font-size:.65rem;color:var(--t3);letter-spacing:2px;text-transform:uppercase}
.nav-tabs{display:flex;gap:2px;background:var(--bg2);border-radius:12px;padding:3px;overflow-x:auto}
.nav-tab{padding:.55rem 1rem;border:none;background:none;color:var(--t2);cursor:pointer;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:500;transition:all .3s;white-space:nowrap}
.nav-tab:hover{color:var(--t1)}.nav-tab.active{background:var(--acc);color:var(--bg);font-weight:600}
.main{position:relative;z-index:1;max-width:1600px;margin:0 auto;padding:1.5rem 2rem}
.panel{display:none;animation:fadeIn .35s ease}.panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.card{background:var(--card);border:1px solid var(--brd);border-radius:14px;padding:1.4rem;margin-bottom:1.4rem;box-shadow:0 4px 20px rgba(0,0,0,.25)}
.card-title{font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
.fg{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem}
.fg label{font-size:.78rem;color:var(--t2);font-weight:500;text-transform:uppercase;letter-spacing:.4px}
.fg input,.fg select{padding:.65rem .9rem;background:var(--inp);border:1px solid var(--brd);border-radius:9px;color:var(--t1);font-family:'Space Mono',monospace;font-size:.88rem;transition:border-color .3s;width:100%}
.fg input:focus,.fg select:focus{outline:none;border-color:var(--acc);box-shadow:0 0 0 3px rgba(245,158,11,.15)}
.fg select option{background:var(--bg2);color:var(--t1)}
.fg .unit{font-size:.72rem;color:var(--t3);font-family:'Space Mono',monospace}
.fg>div{display:flex;flex-direction:column;gap:.3rem}
.btn{padding:.75rem 1.8rem;border:none;border-radius:11px;font-family:'DM Sans',sans-serif;font-weight:600;font-size:.92rem;cursor:pointer;transition:all .3s;display:inline-flex;align-items:center;gap:.4rem}
.btn-p{background:linear-gradient(135deg,var(--acc),var(--accD));color:var(--bg)}
.btn-p:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(245,158,11,.3)}
.btn-s{background:var(--bg2);color:var(--t1);border:1px solid var(--brd)}
.btn-s:hover{border-color:var(--acc)}
.btn-group{display:flex;gap:.7rem;margin-top:1.4rem;flex-wrap:wrap}
.rg{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:.8rem}
.ri{background:var(--inp);border:1px solid var(--brd);border-radius:11px;padding:1rem;text-align:center}
.rv{font-family:'Space Mono',monospace;font-size:1.5rem;font-weight:700;color:var(--acc);line-height:1.2}
.rl{font-size:.72rem;color:var(--t2);margin-top:.25rem;text-transform:uppercase;letter-spacing:.4px}
.ru{font-size:.8rem;color:var(--t3);font-family:'Space Mono',monospace}
.two{display:grid;grid-template-columns:1fr 1fr;gap:1.4rem}
@media(max-width:900px){.two{grid-template-columns:1fr}.header{flex-direction:column}}
.chart-c{position:relative;height:340px;margin:.8rem 0}
.wb{background:rgba(245,158,11,.1);border:1px solid var(--acc);border-radius:10px;padding:1rem;font-size:.85rem;color:var(--accL);margin:1rem 0}
.ib{background:rgba(59,130,246,.1);border:1px solid var(--info);border-radius:10px;padding:1rem;font-size:.85rem;color:#93c5fd;margin:1rem 0}
.sb{display:flex;align-items:center;gap:.5rem;padding:.7rem 1rem;background:var(--inp);border-radius:9px;margin-bottom:1rem;font-size:.83rem}
.sd{width:8px;height:8px;border-radius:50%;background:var(--ok);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.rt{width:100%;border-collapse:collapse;margin:.8rem 0;font-size:.88rem}
.rt th,.rt td{padding:.55rem .9rem;text-align:left;border-bottom:1px solid var(--brd)}
.rt th{color:var(--acc);font-weight:600;text-transform:uppercase;font-size:.73rem;letter-spacing:.4px}
.rs{border-left:3px solid var(--acc);padding-left:1.4rem;margin-bottom:1.4rem}
.rs h3{font-family:'Playfair Display',serif;margin-bottom:.4rem}
.rs p,.rs li{color:var(--t2);line-height:1.65;font-size:.9rem}
.anim-ctrl{display:flex;gap:.8rem;align-items:center;margin:.8rem 0;flex-wrap:wrap}
.anim-ctrl input[type=range]{flex:1;min-width:180px;accent-color:var(--acc)}
.td{font-family:'Space Mono',monospace;color:var(--acc);font-size:1.05rem;min-width:90px}
.pid-box{background:#fff;border-radius:11px;padding:.8rem;margin:.8rem 0;overflow:auto}
.mcb-box{background:#fff;border-radius:11px;padding:.8rem;margin:.8rem 0}
.loading{display:none;position:fixed;inset:0;background:rgba(10,14,26,.88);z-index:1000;justify-content:center;align-items:center;flex-direction:column;gap:1.2rem}
.loading.show{display:flex}
.spinner{width:55px;height:55px;border:3px solid var(--brd);border-top-color:var(--acc);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.lt{font-size:1rem;color:var(--acc);text-align:center}
.tag{display:inline-block;padding:.15rem .5rem;border-radius:5px;font-size:.7rem;font-weight:600;margin-left:.4rem}
.tag-nrtl{background:rgba(59,130,246,.2);color:#93c5fd}
.tag-raoult{background:rgba(16,185,129,.2);color:#6ee7b7}
.tag-azeo{background:rgba(239,68,68,.2);color:#fca5a5}
.tag-unifac{background:rgba(168,85,247,.2);color:#c4b5fd}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--brd);border-radius:3px}
</style>
</head>
<body>
<div class="loading" id="ld"><div class="spinner"></div><div class="lt" id="ldT">Calculs en cours...</div></div>
<header class="header">
  <div class="logo"><div class="logo-icon">‚öóÔ∏è</div><div><div class="logo-text">DistillAI <span style="font-size:.7em;opacity:.7">v2</span></div><div class="logo-sub">Conception colonnes batch ¬∑ Raoult + NRTL + UNIFAC</div></div></div>
  <nav class="nav-tabs" id="navTabs">
    <button class="nav-tab active" onclick="sp('input')">Saisie</button>
    <button class="nav-tab" onclick="sp('results')">R√©sultats</button>
    <button class="nav-tab" onclick="sp('pid')">P&ID</button>
    <button class="nav-tab" onclick="sp('curves')">Courbes</button>
    <button class="nav-tab" onclick="sp('anim')">Animation</button>
    <button class="nav-tab" onclick="sp('mccabe')">McCabe-Thiele</button>
    <button class="nav-tab" onclick="sp('report')">Rapport</button>
  </nav>
</header>
<main class="main">
<!-- INPUT PANEL -->
<div class="panel active" id="p-input">
  <div class="sb"><div class="sd"></div><span>DistillAI v2 ‚Äî Raoult (id√©al) ¬∑ NRTL (non-id√©al) ¬∑ UNIFAC (pr√©dictif) ¬∑ D√©tection d'az√©otropes</span></div>
  <div class="wb">‚ö†Ô∏è <strong>Avertissement</strong> : R√©sultats d'avant-projet. Validation par un ing√©nieur proc√©d√© requise.</div>
  <div class="two">
    <div class="card">
      <div class="card-title">üß™ Composition de l'alimentation</div>
      <div class="fg">
        <div><label>Compos√© l√©ger (distillat)</label><select id="lc" onchange="umi()"></select></div>
        <div><label>Compos√© lourd (r√©sidu)</label><select id="hc" onchange="umi()"></select></div>
      </div>
      <div class="fg" style="margin-top:1rem">
        <div><label>Mod√®le thermodynamique</label><select id="thModel" onchange="umi()"><option value="auto" selected>Auto (NRTL > UNIFAC > Raoult)</option><option value="raoult">Raoult (id√©al)</option><option value="nrtl">NRTL (non-id√©al)</option><option value="unifac">UNIFAC (pr√©dictif)</option></select><span class="unit">NRTL si BIP dispo, sinon UNIFAC pr√©dictif</span></div>
        <div><label>Fraction molaire du l√©ger (xF)</label><input type="number" id="xF" value="0.50" min="0.01" max="0.99" step="0.01"><span class="unit">fraction molaire</span></div>
      </div>
      <div class="fg" style="margin-top:1rem">
        <div><label>Volume de charge</label><input type="number" id="vF" value="1000" min="10" step="10"><span class="unit">litres</span></div>
        <div><label>Puret√© distillat (xD)</label><input type="number" id="xD" value="0.95" min="0.5" max="0.999" step="0.005"><span class="unit">fraction molaire</span></div>
      </div>
      <div class="fg" style="margin-top:1rem">
        <div><label>Fraction r√©siduelle (xW)</label><input type="number" id="xW" value="0.05" min="0.001" max="0.5" step="0.005"><span class="unit">fraction molaire</span></div>
      </div>
      <div id="molInfo" style="display:none;margin-top:1rem"><div class="rg" id="molInfoGrid"></div></div>
      <div id="azeoInfo" style="display:none;margin-top:.8rem"></div>
    </div>
    <div class="card">
      <div class="card-title">‚öôÔ∏è Conditions op√©ratoires</div>
      <div class="fg">
        <div><label>Pression de service</label><input type="number" id="P" value="101.325" min="10" max="500" step="1"><span class="unit">kPa (101.325 = atm)</span></div>
        <div><label>Type d'internes</label><select id="int"><option value="sieve">Plateaux perfor√©s</option><option value="valve">Plateaux √† clapets</option><option value="structured" selected>Garnissage structur√©</option><option value="random">Garnissage en vrac</option></select></div>
      </div>
      <div class="fg" style="margin-top:1rem">
        <div><label>Politique de reflux</label><select id="rpol"><option value="constant" selected>Reflux constant</option><option value="variable">Reflux variable (puret√© cste)</option></select></div>
        <div><label>Ratio R/Rmin</label><input type="number" id="RR" value="1.3" min="1.05" max="5" step="0.05"><span class="unit">Typique : 1.2 √† 1.5</span></div>
      </div>
      <div class="fg" style="margin-top:1rem">
        <div><label>% de flooding</label><input type="number" id="flood" value="75" min="50" max="85" step="1"><span class="unit">% (reco : 70-80%)</span></div>
        <div><label>Efficacit√© HETP</label><select id="eff"><option value="0.5">50% ‚Äî Faible</option><option value="0.65" selected>65% ‚Äî Standard</option><option value="0.75">75% ‚Äî Bon garnissage</option><option value="0.85">85% ‚Äî Excellent</option></select></div>
      </div>
      <div class="fg" style="margin-top:1rem">
        <div><label>Mat√©riau</label><select id="mat"><option value="ss316" selected>Inox 316L</option><option value="ss304">Inox 304</option><option value="hastelloy">Hastelloy C-276</option><option value="glass">Verre borosilicat√©</option><option value="ptfe">Rev√™tement PTFE</option></select></div>
        <div><label>Condenseur</label><select id="cond"><option value="total" selected>Total</option><option value="partial">Partiel</option></select></div>
      </div>
    </div>
  </div>
  <div class="btn-group" style="justify-content:center">
    <button class="btn btn-p" onclick="calc()">‚ö° Lancer le dimensionnement</button>
    <button class="btn btn-s" onclick="location.reload()">‚Ü∫ R√©initialiser</button>
  </div>
</div>
<!-- RESULTS -->
<div class="panel" id="p-results">
  <div id="rModelTag"></div>
  <div class="card"><div class="card-title">üìê Dimensionnement</div><div class="rg" id="rCol"></div></div>
  <div class="two">
    <div class="card"><div class="card-title">üî• Bilan thermique</div><div class="rg" id="rTh"></div></div>
    <div class="card"><div class="card-title">‚è±Ô∏è Bilan mati√®re & temps</div><div class="rg" id="rMa"></div></div>
  </div>
  <div class="card"><div class="card-title">üîß Auxiliaires</div><div class="rg" id="rAux"></div></div>
  <div class="card"><div class="card-title">üõ°Ô∏è S√©curit√©</div><div id="rSaf"></div></div>
</div>
<!-- P&ID -->
<div class="panel" id="p-pid">
  <div class="card"><div class="card-title">üìã P&ID ‚Äî ISO 14617 / ISA 5.1</div>
    <div class="pid-box"><svg id="pidSvg" viewBox="0 0 1400 900" width="100%" style="min-height:600px"></svg></div>
    <div class="btn-group">
      <button class="btn btn-s" onclick="dlPID()">üì• T√©l√©charger SVG</button>
      <button class="btn btn-s" onclick="dlPIDpng()">üì• T√©l√©charger PNG</button>
    </div>
    <div class="ib" style="margin-top:.8rem">Conforme ISO 14617 (√©quipements, vannes) + ISA 5.1 (codification instruments). Boucles de r√©gulation : TIC (temp√©rature), LIC (niveau), PIC (pression), FIC (d√©bit). Soupape de s√ªret√© PSV conforme DESP.</div>
  </div>
</div>
<!-- CURVES -->
<div class="panel" id="p-curves">
  <div class="two">
    <div class="card"><div class="card-title">üìà Composition vs Temps</div><div class="chart-c"><canvas id="cComp"></canvas></div></div>
    <div class="card"><div class="card-title">üå°Ô∏è Temp√©ratures</div><div class="chart-c"><canvas id="cTemp"></canvas></div></div>
  </div>
  <div class="two">
    <div class="card"><div class="card-title">‚ö° Puissance thermique</div><div class="chart-c"><canvas id="cPow"></canvas></div></div>
    <div class="card"><div class="card-title">üîÑ Reflux & D√©bit</div><div class="chart-c"><canvas id="cRef"></canvas></div></div>
  </div>
  <div class="card"><div class="card-title">üìä Volume cumul√©</div><div class="chart-c"><canvas id="cVol"></canvas></div></div>
</div>
<!-- ANIMATION -->
<div class="panel" id="p-anim">
  <div class="card"><div class="card-title">üé¨ PFD Anim√© ‚Äî Distillation Batch ‚Äî ISO 10628</div>
    <div style="display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;margin-bottom:.6rem">
      <button class="btn btn-p" id="btnPP" onclick="toggleAnim()" style="min-width:110px">‚ñ∂ D√©marrer</button>
      <button class="btn btn-s" onclick="resetAnim()" style="padding:.4rem .8rem;font-size:.78rem">‚èÆ Reset</button>
      <input type="range" id="tSlider" min="0" max="100" value="0" step="0.1" oninput="drawAnim(+this.value)" style="flex:1;min-width:150px">
      <div class="td" id="tDisp" style="min-width:90px;text-align:center">t = 0 min</div>
    </div>
    <div style="display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;margin-bottom:.8rem;font-size:.82rem;color:var(--t3)">
      <span>Vitesse :</span>
      <button class="btn btn-s aspd" onclick="setSpd(.25)" style="padding:.25rem .5rem;font-size:.75rem">0.25x</button>
      <button class="btn btn-s aspd" onclick="setSpd(.5)" style="padding:.25rem .5rem;font-size:.75rem">0.5x</button>
      <button class="btn btn-s aspd active" onclick="setSpd(1)" style="padding:.25rem .5rem;font-size:.75rem">1x</button>
      <button class="btn btn-s aspd" onclick="setSpd(2)" style="padding:.25rem .5rem;font-size:.75rem">2x</button>
      <button class="btn btn-s aspd" onclick="setSpd(5)" style="padding:.25rem .5rem;font-size:.75rem">5x</button>
      <button class="btn btn-s aspd" onclick="setSpd(10)" style="padding:.25rem .5rem;font-size:.75rem">10x</button>
      <span style="margin-left:.3rem">ou</span>
      <input type="number" id="aSpdCustom" min="0.1" max="50" step="0.1" value="" placeholder="perso" style="width:65px;background:var(--inp);color:var(--t1);border:1px solid var(--brd);border-radius:5px;padding:3px 6px;font-size:.78rem" oninput="setSpdCustom()">
      <span>x</span>
    </div>
    <div style="background:#fafafa;border-radius:8px;padding:6px;position:relative;min-height:550px;border:1px solid #ccc">
      <svg id="aSvg" viewBox="0 0 1200 780" width="100%" style="display:block"></svg>
    </div>
    <div class="rg" id="aMet"></div>
  </div>
</div>
<!-- McCABE -->
<div class="panel" id="p-mccabe">
  <div class="card"><div class="card-title">üìê McCabe-Thiele</div>
    <div style="display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;margin-bottom:.6rem">
      <span style="font-size:.8rem;color:var(--t3);white-space:nowrap">üîç Zoom :</span>
      <input type="range" id="mcZoomSlider" min="1" max="20" step="0.5" value="1" oninput="mcSliderZoom()" style="flex:1;min-width:120px;max-width:200px">
      <span id="mcZoomLbl" style="font-size:.78rem;color:var(--t2);min-width:35px">1√ó</span>
      <button class="btn btn-s" onclick="mcZoom('full')" style="padding:.35rem .7rem;font-size:.75rem">Vue compl√®te</button>
      <button class="btn btn-s" onclick="mcZoom('steps')" style="padding:.35rem .7rem;font-size:.75rem">Zoom √©tages</button>
      <button class="btn btn-s" onclick="mcZoom('top')" style="padding:.35rem .7rem;font-size:.75rem">T√™te (xD)</button>
      <button class="btn btn-s" onclick="mcZoom('bot')" style="padding:.35rem .7rem;font-size:.75rem">Pied (xW)</button>
      <button class="btn btn-s" onclick="mcZoom('feed')" style="padding:.35rem .7rem;font-size:.75rem">Feed (xF)</button>
      <button class="btn btn-s" onclick="dlMcCabe()" style="padding:.35rem .7rem;font-size:.75rem">üì• SVG</button>
    </div>
    <div style="font-size:.72rem;color:var(--t3);margin-bottom:.5rem">üí° Slider = zoom ¬∑ Molette souris = zoom au curseur ¬∑ Cliquer-glisser = d√©placer ¬∑ Boutons = vues pr√©d√©finies</div>
    <div class="mcb-box" style="overflow:hidden;position:relative;cursor:grab" id="mcbContainer">
      <svg id="mcSvg" viewBox="0 0 800 800" width="100%" style="display:block"></svg>
    </div>
    <div class="rg" id="mcRes"></div>
  </div>
</div>
<!-- REPORT -->
<div class="panel" id="p-report">
  <div class="card"><div class="card-title">üìÑ Rapport</div>
    <div id="repC"></div>
    <div class="btn-group">
      <button class="btn btn-p" onclick="dlReport()">üì• HTML</button>
      <button class="btn btn-s" onclick="window.print()">üñ®Ô∏è Imprimer</button>
    </div>
  </div>
</div>
</main>
<script>
// ========================================================================
// DistillAI v2 ‚Äî NRTL + Raoult + Azeotrope Detection
// Sources: NIST WebBook, Perry's 9th ed., DECHEMA VLE Data Series
// ========================================================================

// ===== SOLVENT DATABASE =====
const S={
methanol:{n:"M√©thanol",f:"CH‚ÇÉOH",cas:"67-56-1",mw:32.04,tb:64.7,d:.791,ant:{A:8.08097,B:1582.271,C:239.726},hv:35.21,cp:2.53,fp:12,haz:["Inflammable","Toxique"]},
ethanol:{n:"√âthanol",f:"C‚ÇÇH‚ÇÖOH",cas:"64-17-5",mw:46.07,tb:78.37,d:.789,ant:{A:8.11220,B:1592.864,C:226.184},hv:38.56,cp:2.44,fp:13,haz:["Inflammable"]},
isopropanol:{n:"Isopropanol",f:"(CH‚ÇÉ)‚ÇÇCHOH",cas:"67-63-0",mw:60.10,tb:82.6,d:.786,ant:{A:8.11778,B:1580.92,C:219.61},hv:39.85,cp:2.60,fp:12,haz:["Inflammable","Irritant"]},
acetone:{n:"Ac√©tone",f:"(CH‚ÇÉ)‚ÇÇCO",cas:"67-64-1",mw:58.08,tb:56.05,d:.790,ant:{A:7.11714,B:1210.595,C:229.664},hv:29.10,cp:2.17,fp:-20,haz:["Tr√®s inflammable","Irritant"]},
ethyl_acetate:{n:"Ac√©tate d'√©thyle",f:"CH‚ÇÉCOOC‚ÇÇH‚ÇÖ",cas:"141-78-6",mw:88.11,tb:77.1,d:.902,ant:{A:7.10179,B:1244.951,C:217.881},hv:31.94,cp:1.93,fp:-4,haz:["Tr√®s inflammable","Irritant"]},
benzene:{n:"Benz√®ne",f:"C‚ÇÜH‚ÇÜ",cas:"71-43-2",mw:78.11,tb:80.1,d:.879,ant:{A:6.90565,B:1211.033,C:220.790},hv:30.72,cp:1.74,fp:-11,haz:["Tr√®s inflammable","CMR cat.1","Toxique"]},
toluene:{n:"Tolu√®ne",f:"C‚ÇÜH‚ÇÖCH‚ÇÉ",cas:"108-88-3",mw:92.14,tb:110.6,d:.867,ant:{A:6.95464,B:1344.800,C:219.482},hv:33.18,cp:1.71,fp:4,haz:["Inflammable","Toxique","CMR suspect√©"]},
dcm:{n:"Dichlorom√©thane",f:"CH‚ÇÇCl‚ÇÇ",cas:"75-09-2",mw:84.93,tb:39.6,d:1.326,ant:{A:7.08030,B:1138.910,C:231.450},hv:28.06,cp:1.19,fp:null,haz:["Toxique","CMR suspect√©"]},
thf:{n:"THF",f:"C‚ÇÑH‚ÇàO",cas:"109-99-9",mw:72.11,tb:66.0,d:.889,ant:{A:6.99515,B:1202.290,C:226.254},hv:31.80,cp:1.72,fp:-14,haz:["Tr√®s inflammable","Peroxydes","Irritant"]},
hexane:{n:"n-Hexane",f:"C‚ÇÜH‚ÇÅ‚ÇÑ",cas:"110-54-3",mw:86.18,tb:68.7,d:.659,ant:{A:6.87776,B:1171.530,C:224.366},hv:28.85,cp:2.27,fp:-22,haz:["Tr√®s inflammable","Neurotoxique"]},
heptane:{n:"n-Heptane",f:"C‚ÇáH‚ÇÅ‚ÇÜ",cas:"142-82-5",mw:100.20,tb:98.4,d:.684,ant:{A:6.89385,B:1264.370,C:216.636},hv:31.77,cp:2.24,fp:-4,haz:["Inflammable","Irritant"]},
cyclohexane:{n:"Cyclohexane",f:"C‚ÇÜH‚ÇÅ‚ÇÇ",cas:"110-82-7",mw:84.16,tb:80.7,d:.779,ant:{A:6.84130,B:1201.531,C:222.647},hv:29.97,cp:1.85,fp:-20,haz:["Tr√®s inflammable","Nocif"]},
butanol:{n:"n-Butanol",f:"C‚ÇÑH‚ÇâOH",cas:"71-36-3",mw:74.12,tb:117.7,d:.810,ant:{A:7.36366,B:1305.198,C:173.427},hv:43.29,cp:2.39,fp:29,haz:["Inflammable","Irritant"]},
water:{n:"Eau",f:"H‚ÇÇO",cas:"7732-18-5",mw:18.015,tb:100.0,d:.998,ant:{A:8.07131,B:1730.630,C:233.426},hv:40.65,cp:4.18,fp:null,haz:[]},
xylene:{n:"Xyl√®ne (m√©l.)",f:"C‚ÇàH‚ÇÅ‚ÇÄ",cas:"1330-20-7",mw:106.16,tb:139.0,d:.860,ant:{A:6.99052,B:1453.430,C:215.307},hv:34.21,cp:1.72,fp:27,haz:["Inflammable","Nocif"]},
acetonitrile:{n:"Ac√©tonitrile",f:"CH‚ÇÉCN",cas:"75-05-8",mw:41.05,tb:82.0,d:.786,ant:{A:7.11988,B:1314.400,C:230.000},hv:33.23,cp:2.23,fp:2,haz:["Inflammable","Toxique"]},
mek:{n:"MEK",f:"CH‚ÇÉCOC‚ÇÇH‚ÇÖ",cas:"78-93-3",mw:72.11,tb:79.6,d:.805,ant:{A:7.06356,B:1261.340,C:221.969},hv:31.30,cp:2.14,fp:-9,haz:["Tr√®s inflammable","Irritant"]},
diethyl_ether:{n:"√âther di√©thylique",f:"(C‚ÇÇH‚ÇÖ)‚ÇÇO",cas:"60-29-7",mw:74.12,tb:34.6,d:.713,ant:{A:6.92032,B:1064.066,C:228.799},hv:26.52,cp:2.37,fp:-45,haz:["Extr√™mement inflammable","Peroxydes"]},
dmf:{n:"DMF",f:"(CH‚ÇÉ)‚ÇÇNCHO",cas:"68-12-2",mw:73.09,tb:153.0,d:.944,ant:{A:6.92817,B:1400.869,C:196.475},hv:46.89,cp:2.10,fp:58,haz:["Toxique","Reprotoxique"]},
chloroform:{n:"Chloroforme",f:"CHCl‚ÇÉ",cas:"67-66-3",mw:119.38,tb:61.2,d:1.489,ant:{A:6.93710,B:1171.200,C:226.960},hv:29.24,cp:.96,fp:null,haz:["Toxique","CMR suspect√©"]},
dmso:{n:"DMSO",f:"(CH‚ÇÉ)‚ÇÇSO",cas:"67-68-5",mw:78.13,tb:189.0,d:1.100,ant:{A:7.28050,B:1724.000,C:199.000},hv:43.10,cp:1.96,fp:89,haz:["Irritant"]},
acetic_acid:{n:"Acide ac√©tique",f:"CH‚ÇÉCOOH",cas:"64-19-7",mw:60.05,tb:117.9,d:1.049,ant:{A:7.38782,B:1533.313,C:222.309},hv:23.70,cp:2.05,fp:39,haz:["Inflammable","Corrosif"]},
pentane:{n:"n-Pentane",f:"C‚ÇÖH‚ÇÅ‚ÇÇ",cas:"109-66-0",mw:72.15,tb:36.1,d:.626,ant:{A:6.85221,B:1064.630,C:232.000},hv:25.79,cp:2.32,fp:-49,haz:["Extr√™mement inflammable"]},
methyl_acetate:{n:"Ac√©tate de m√©thyle",f:"CH‚ÇÉCOOCH‚ÇÉ",cas:"79-20-9",mw:74.08,tb:56.9,d:.932,ant:{A:7.06524,B:1157.630,C:219.726},hv:30.32,cp:2.14,fp:-10,haz:["Tr√®s inflammable","Irritant"]},
// --- Alcools ---
propanol:{n:"n-Propanol",f:"C‚ÇÉH‚ÇáOH",cas:"71-23-8",mw:60.10,tb:97.2,d:.804,ant:{A:7.74416,B:1437.686,C:198.463},hv:41.44,cp:2.39,fp:15,haz:["Inflammable","Irritant"]},
sec_butanol:{n:"2-Butanol",f:"C‚ÇÑH‚ÇâOH",cas:"78-92-2",mw:74.12,tb:99.5,d:.808,ant:{A:7.20131,B:1157.000,C:168.279},hv:40.75,cp:2.35,fp:24,haz:["Inflammable","Irritant"]},
pentanol:{n:"1-Pentanol",f:"C‚ÇÖH‚ÇÅ‚ÇÅOH",cas:"71-41-0",mw:88.15,tb:137.8,d:.814,ant:{A:7.18246,B:1287.625,C:161.330},hv:44.36,cp:2.33,fp:33,haz:["Inflammable","Nocif"]},
ethylene_glycol:{n:"√âthyl√®ne glycol",f:"HOCH‚ÇÇCH‚ÇÇOH",cas:"107-21-1",mw:62.07,tb:197.3,d:1.113,ant:{A:8.09083,B:2088.936,C:203.454},hv:50.50,cp:2.41,fp:111,haz:["Nocif"]},
// --- Hydrocarbures ---
octane:{n:"n-Octane",f:"C‚ÇàH‚ÇÅ‚Çà",cas:"111-65-9",mw:114.23,tb:125.7,d:.703,ant:{A:6.91874,B:1351.756,C:209.100},hv:34.41,cp:2.23,fp:13,haz:["Inflammable","Nocif"]},
decane:{n:"n-D√©cane",f:"C‚ÇÅ‚ÇÄH‚ÇÇ‚ÇÇ",cas:"124-18-5",mw:142.28,tb:174.1,d:.730,ant:{A:6.94365,B:1501.268,C:194.480},hv:38.75,cp:2.21,fp:46,haz:["Inflammable"]},
styrene:{n:"Styr√®ne",f:"C‚ÇÜH‚ÇÖCH=CH‚ÇÇ",cas:"100-42-5",mw:104.15,tb:145.0,d:.909,ant:{A:6.92409,B:1420.000,C:206.000},hv:36.82,cp:1.73,fp:31,haz:["Inflammable","CMR suspect√©","Irritant"]},
ethylbenzene:{n:"√âthylbenz√®ne",f:"C‚ÇÜH‚ÇÖC‚ÇÇH‚ÇÖ",cas:"100-41-4",mw:106.17,tb:136.2,d:.867,ant:{A:6.95650,B:1423.543,C:213.091},hv:35.57,cp:1.75,fp:15,haz:["Inflammable","Nocif"]},
isooctane:{n:"Isooctane",f:"(CH‚ÇÉ)‚ÇÉCCH‚ÇÇCH(CH‚ÇÉ)‚ÇÇ",cas:"540-84-1",mw:114.23,tb:99.2,d:.692,ant:{A:6.88814,B:1319.529,C:211.625},hv:30.79,cp:2.09,fp:-12,haz:["Tr√®s inflammable"]},
// --- Solvants chlor√©s ---
edc:{n:"1,2-Dichloro√©thane",f:"ClCH‚ÇÇCH‚ÇÇCl",cas:"107-06-2",mw:98.96,tb:83.5,d:1.253,ant:{A:7.02530,B:1271.254,C:222.927},hv:31.98,cp:1.29,fp:13,haz:["Inflammable","Toxique","CMR cat.1"]},
carbon_tet:{n:"T√©trachlorure de carbone",f:"CCl‚ÇÑ",cas:"56-23-5",mw:153.82,tb:76.7,d:1.594,ant:{A:6.87926,B:1212.021,C:226.409},hv:29.82,cp:.86,fp:null,haz:["Toxique","CMR suspect√©","Dangereux environnement"]},
perchloroethylene:{n:"Perchloro√©thyl√®ne",f:"Cl‚ÇÇC=CCl‚ÇÇ",cas:"127-18-4",mw:165.83,tb:121.3,d:1.623,ant:{A:6.97600,B:1386.920,C:217.530},hv:34.68,cp:.90,fp:null,haz:["Toxique","CMR suspect√©"]},
chlorobenzene:{n:"Chlorobenz√®ne",f:"C‚ÇÜH‚ÇÖCl",cas:"108-90-7",mw:112.56,tb:131.7,d:1.106,ant:{A:6.97808,B:1431.053,C:217.551},hv:35.19,cp:1.34,fp:28,haz:["Inflammable","Nocif"]},
// --- Acides / Bases ---
formic_acid:{n:"Acide formique",f:"HCOOH",cas:"64-18-6",mw:46.03,tb:100.8,d:1.220,ant:{A:7.58178,B:1699.200,C:260.700},hv:22.69,cp:2.15,fp:69,haz:["Inflammable","Corrosif","Toxique"]},
propionic_acid:{n:"Acide propionique",f:"C‚ÇÇH‚ÇÖCOOH",cas:"79-09-4",mw:74.08,tb:141.2,d:.993,ant:{A:7.71423,B:1733.418,C:217.724},hv:32.26,cp:2.15,fp:52,haz:["Inflammable","Corrosif"]},
aniline:{n:"Aniline",f:"C‚ÇÜH‚ÇÖNH‚ÇÇ",cas:"62-53-3",mw:93.13,tb:184.1,d:1.022,ant:{A:7.32010,B:1731.515,C:206.049},hv:42.44,cp:2.06,fp:70,haz:["Toxique","CMR suspect√©"]},
triethylamine:{n:"Tri√©thylamine",f:"(C‚ÇÇH‚ÇÖ)‚ÇÉN",cas:"121-44-8",mw:101.19,tb:88.9,d:.726,ant:{A:6.89894,B:1276.900,C:218.000},hv:31.01,cp:2.32,fp:-9,haz:["Tr√®s inflammable","Corrosif","Toxique"]}
};

// ===== NRTL BINARY INTERACTION PARAMETERS =====
// tau_ij = a_ij + b_ij/T(K); G_ij = exp(-alpha * tau_ij)
// Source: DECHEMA VLE Data Series, Gmehling et al.
const NRTL_BIP = {
"ethanol|water":{a12:-.8009,a21:3.4578,b12:246.18,b21:-586.08,alpha:.3},
"methanol|water":{a12:-.6930,a21:3.1460,b12:184.70,b21:-520.36,alpha:.3},
"isopropanol|water":{a12:1.0930,a21:2.3320,b12:170.90,b21:-583.20,alpha:.3},
"acetone|water":{a12:2.0094,a21:3.7876,b12:-414.31,b21:-644.74,alpha:.3},
"butanol|water":{a12:-.1279,a21:4.8274,b12:-49.280,b21:-1166.5,alpha:.4},
"thf|water":{a12:1.8490,a21:4.9530,b12:-176.8,b21:-1350.0,alpha:.3},
"acetic_acid|water":{a12:-.2705,a21:1.2130,b12:235.28,b21:-339.85,alpha:.3},
"acetonitrile|water":{a12:1.5780,a21:3.3290,b12:-108.42,b21:-739.68,alpha:.3},
"dmf|water":{a12:-.1450,a21:.6480,b12:52.300,b21:-213.60,alpha:.3},
"acetone|methanol":{a12:.1850,a21:.4750,b12:82.100,b21:-161.40,alpha:.3},
"acetone|ethanol":{a12:-.1380,a21:.7650,b12:122.90,b21:-204.30,alpha:.3},
"chloroform|methanol":{a12:1.3660,a21:-.3420,b12:-357.2,b21:226.40,alpha:.3},
"acetone|chloroform":{a12:-1.105,a21:1.7580,b12:361.88,b21:-398.97,alpha:.3},
"benzene|ethanol":{a12:1.8360,a21:1.7940,b12:-302.6,b21:-199.4,alpha:.47},
"cyclohexane|ethanol":{a12:2.6740,a21:1.8440,b12:-442.8,b21:-79.30,alpha:.47},
"benzene|water":{a12:4.8240,a21:5.1740,b12:-840.6,b21:-2253.0,alpha:.2},
"ethanol|hexane":{a12:3.1340,a21:1.2680,b12:-565.4,b21:128.20,alpha:.47},
"ethanol|toluene":{a12:1.0100,a21:1.9910,b12:-43.28,b21:-345.70,alpha:.47},
"methanol|toluene":{a12:1.5940,a21:2.5120,b12:-189.4,b21:-513.60,alpha:.47},
"ethanol|ethyl_acetate":{a12:.7450,a21:.8060,b12:-106.3,b21:-93.500,alpha:.3},
"methanol|ethyl_acetate":{a12:.9320,a21:1.2800,b12:-102.0,b21:-252.10,alpha:.3},
"benzene|cyclohexane":{a12:.4580,a21:-.3050,b12:-74.600,b21:120.80,alpha:.3},
"benzene|toluene":{a12:.1530,a21:-.0620,b12:-25.300,b21:37.400,alpha:.3},
"hexane|toluene":{a12:.2260,a21:-.0830,b12:-46.800,b21:52.300,alpha:.3},
"methanol|hexane":{a12:3.9840,a21:1.8470,b12:-811.2,b21:135.60,alpha:.47},
"mek|water":{a12:2.1240,a21:3.8560,b12:-380.5,b21:-728.30,alpha:.3},
"dcm|methanol":{a12:.8250,a21:.6120,b12:-198.3,b21:-42.80,alpha:.3},
"cyclohexane|hexane":{a12:.05,a21:-.02,b12:-10.5,b21:8.2,alpha:.3},
"heptane|toluene":{a12:.19,a21:-.06,b12:-38.2,b21:42.1,alpha:.3},
"propanol|water":{a12:.7750,a21:2.7840,b12:135.90,b21:-496.20,alpha:.3},
"formic_acid|water":{a12:-.4120,a21:-.0130,b12:248.30,b21:-47.800,alpha:.3},
"propionic_acid|water":{a12:-.0580,a21:1.3470,b12:197.50,b21:-408.60,alpha:.3},
"edc|ethanol":{a12:.6840,a21:.5120,b12:-96.300,b21:-28.400,alpha:.3},
"octane|toluene":{a12:.0430,a21:-.0280,b12:-8.4000,b21:12.800,alpha:.3},
"ethylbenzene|styrene":{a12:.0120,a21:-.0080,b12:-2.8000,b21:4.2000,alpha:.3},
"chlorobenzene|toluene":{a12:.0850,a21:-.0520,b12:-14.200,b21:28.600,alpha:.3},
"ethylene_glycol|water":{a12:-.0710,a21:.5830,b12:87.400,b21:-254.30,alpha:.3},
};

// ===== THERMODYNAMIC ENGINE =====
let R_=null,charts={},animId=null,playing=false;

function antP(s,T){return Math.pow(10,s.ant.A-s.ant.B/(s.ant.C+T))*.133322} // mmHg->kPa

function getNRTL(k1,k2){
  let key=k1+'|'+k2;if(NRTL_BIP[key])return{bip:NRTL_BIP[key],swap:false};
  key=k2+'|'+k1;if(NRTL_BIP[key])return{bip:NRTL_BIP[key],swap:true};
  return null;
}

function nrtlGamma(k1,k2,x1,T){
  const nd=getNRTL(k1,k2);if(!nd)return[1,1];
  const TK=T+273.15,x2=1-x1;
  if(x1<1e-10||x2<1e-10)return[1,1];
  let{a12,a21,b12,b21,alpha}=nd.bip;
  if(nd.swap){[a12,a21]=[a21,a12];[b12,b21]=[b21,b12]}
  const tau12=a12+b12/TK,tau21=a21+b21/TK;
  const G12=Math.exp(-alpha*tau12),G21=Math.exp(-alpha*tau21);
  const d1=x1+x2*G21,d2=x2+x1*G12;
  const lnG1=x2*x2*(tau21*Math.pow(G21/d1,2)+tau12*G12/Math.pow(d2,2));
  const lnG2=x1*x1*(tau12*Math.pow(G12/d2,2)+tau21*G21/Math.pow(d1,2));
  return[Math.exp(Math.min(lnG1,10)),Math.exp(Math.min(lnG2,10))];
}

// ===== UNIFAC MODEL (Fredenslund, Jones, Prausnitz) =====
// Group parameters: {mainGroup, subGroup, Rk, Qk}
// Source: UNIFAC consortium, Gmehling et al., Ind. Eng. Chem. Res.
const UNIFAC_GROUPS = {
  // Main group 1: CH2
  'CH3':  {main:1,sub:1, R:0.9011,Q:0.848},
  'CH2':  {main:1,sub:2, R:0.6744,Q:0.540},
  'CH':   {main:1,sub:3, R:0.4469,Q:0.228},
  'C':    {main:1,sub:4, R:0.2195,Q:0.000},
  // Main group 2: C=C
  'CH2=CH':{main:2,sub:5, R:1.3454,Q:1.176},
  'CH=CH': {main:2,sub:6, R:1.1167,Q:0.867},
  // Main group 3: ACH (aromatic CH)
  'ACH':  {main:3,sub:9, R:0.5313,Q:0.400},
  'AC':   {main:3,sub:10,R:0.3652,Q:0.120},
  // Main group 4: ACCH2
  'ACCH3':{main:4,sub:11,R:1.2663,Q:0.968},
  'ACCH2':{main:4,sub:12,R:1.0396,Q:0.660},
  // Main group 5: OH
  'OH':   {main:5,sub:14,R:1.0000,Q:1.200},
  // Main group 6: CH3OH (methanol special)
  'CH3OH':{main:6,sub:15,R:1.4311,Q:1.432},
  // Main group 7: H2O
  'H2O':  {main:7,sub:16,R:0.9200,Q:1.400},
  // Main group 8: ACOH (phenol)
  'ACOH': {main:8,sub:17,R:0.8952,Q:0.680},
  // Main group 9: CH2CO (ketone)
  'CH3CO':{main:9,sub:18,R:1.6724,Q:1.488},
  'CH2CO':{main:9,sub:19,R:1.4457,Q:1.180},
  // Main group 10: CHO (aldehyde)
  'CHO':  {main:10,sub:20,R:0.9980,Q:0.948},
  // Main group 11: CCOO (ester)
  'CH3COO':{main:11,sub:21,R:1.9031,Q:1.728},
  'CH2COO':{main:11,sub:22,R:1.6764,Q:1.420},
  // Main group 13: CH2O (ether)
  'CH3O': {main:13,sub:24,R:1.1450,Q:1.088},
  'CH2O': {main:13,sub:25,R:0.9183,Q:0.780},
  'THF':  {main:13,sub:27,R:0.9183,Q:1.100},
  // Main group 14: ACCl (aromatic chloride)
  'ACCl': {main:14,sub:29,R:1.1562,Q:0.844},
  // Main group 15: CNH (amine)
  'CH3NH':{main:15,sub:31,R:1.4337,Q:1.244},
  'CH3N': {main:15,sub:33,R:0.9795,Q:0.624},
  // Main group 16: ACNH2 (aromatic amine)
  'ACNH2':{main:16,sub:34,R:1.0600,Q:0.816},
  // Main group 18: pyridine
  // Main group 20: COOH (acid)
  'COOH': {main:20,sub:42,R:1.3013,Q:1.224},
  // Main group 21: CCl (mono-chloro alkane)
  'CH2Cl':{main:21,sub:44,R:1.4654,Q:1.264},
  'CHCl': {main:21,sub:45,R:1.2380,Q:0.952},
  // Main group 22: CCl2
  'CCl2': {main:22,sub:48,R:2.6401,Q:2.184},
  // Main group 23: CCl3
  'CHCl3':{main:23,sub:50,R:2.8700,Q:2.410},
  // Main group 24: CCl4
  'CCl4': {main:24,sub:52,R:3.3900,Q:2.910},
  // Main group 25: ACCH2Cl / CH2Cl2
  'CH2Cl2':{main:25,sub:53,R:2.2564,Q:1.988},
  // Main group 39: DMF
  'DMF':  {main:39,sub:72,R:3.0856,Q:2.736},
  // Main group 43: HCOOH (formic acid)
  'HCOOH':{main:43,sub:79,R:1.5280,Q:1.532},
  // Main group 35: DMSO
  'DMSO': {main:35,sub:67,R:2.8266,Q:2.472},
  // Main group 40: CF2
  // Main group 42: cy (cyclic)
  'cCH2': {main:42,sub:78,R:0.6744,Q:0.540},
  // Main group 41: CON (amide)
  // Main group 44: NMP
  // ACN special group for acetonitrile
  'CH3CN':{main:40,sub:75,R:1.8701,Q:1.724},
};

// UNIFAC group-group interaction parameters: a_mn (K)
// Format: UNIFAC_AMATRIX[m][n] = a_mn
// Source: Gmehling et al., UNIFAC tables (original parameters)
const UNIFAC_A = {
  // Source: Gmehling et al., UNIFAC tables (original parameters)
  // Main groups: 1=CH2, 2=C=C, 3=ACH, 4=ACCH2, 5=OH, 6=CH3OH, 7=H2O,
  // 9=CH2CO, 10=CHO, 11=CCOO, 13=CH2O, 14=ACCl, 15=CNH, 16=ACNH2,
  // 20=COOH, 21=CCl, 22=CCl2, 23=CCl3, 24=CCl4, 25=ACCH2Cl/CH2Cl2,
  // 35=DMSO, 39=DMF, 40=CF2/ACN, 42=cy, 43=HCOOH
  1:{1:0,2:0,3:61.13,4:76.50,5:986.5,6:697.2,7:1318,9:476.4,10:677.0,11:232.1,13:251.5,14:56.08,15:65.33,16:1139,20:663.5,21:35.93,22:53.76,23:24.90,24:104.3,25:36.70,35:526.1,39:485.3,40:597.0,42:0,43:339.1},
  2:{1:0,2:0,3:340.7,4:4102,5:693.9,6:1509,7:270.6,9:524.5,11:37.85,13:214.5,21:0,22:0,23:0,24:0,42:0},
  3:{1:-11.12,2:-94.78,3:0,4:167.0,5:636.1,6:637.3,7:903.8,9:25.77,10:347.3,11:5.994,13:32.14,14:-64.38,15:-13.70,16:1218,20:537.4,21:47.41,22:-52.10,23:-18.81,24:121.3,25:-114.8,35:183.0,39:38.89,40:336.9,42:-11.12,43:139.8},
  4:{1:-69.70,2:-269.7,3:-146.8,4:0,5:803.2,6:603.3,7:5695,9:5.708,11:5688,13:-24.35,14:-141.4,42:-69.70},
  5:{1:156.4,2:457.0,3:89.60,4:25.82,5:0,6:-137.1,7:353.5,9:84.00,10:441.8,11:101.1,13:28.06,14:104.7,15:-113.6,16:-15.62,20:199.0,21:75.62,22:185.4,23:-38.32,24:143.1,25:185.4,35:-291.5,39:218.0,40:6.712,42:156.4,43:-17.25},
  6:{1:16.51,2:-12.52,3:-50.00,4:0,5:-137.1,6:0,7:-181.0,9:-195.4,11:-10.72,13:540.5,42:16.51},
  7:{1:300.0,2:496.1,3:362.3,4:377.6,5:-229.1,6:289.6,7:0,9:-195.4,10:242.8,11:72.87,13:540.5,14:370.4,15:48.89,16:-221.5,20:-14.09,21:370.7,22:321.5,23:252.7,24:0,25:321.5,35:240.9,39:-160.7,40:112.6,42:300.0,43:-118.1},
  9:{1:26.76,2:-82.92,3:140.1,4:-141.3,5:164.5,6:108.7,7:472.5,9:0,10:-37.36,11:-213.7,13:85.84,14:179.7,15:-87.31,20:669.4,21:-18.80,22:135.9,23:-24.36,24:0,25:135.9,35:188.0,39:172.2,40:481.7,42:26.76,43:0},
  10:{1:505.7,3:529.0,5:529.0,7:480.8,9:128.0,10:0,11:-110.3,20:-236.5,23:0,42:505.7},
  11:{1:114.8,2:269.3,3:85.84,4:0,5:245.4,6:-235.7,7:200.8,9:-164.0,10:-197.5,11:0,13:237.7,14:-59.40,20:-256.3,21:52.13,23:-78.53,25:0,35:10.17,39:-46.39,40:-40.90,42:114.8},
  13:{1:83.36,2:26.51,3:-44.85,4:-22.31,5:237.7,6:-234.0,7:10.72,9:23.39,11:461.3,13:0,14:0,20:-338.5,21:-39.16,23:225.4,42:83.36},
  14:{1:-30.10,3:4.680,4:167.0,5:-78.45,7:-406.8,9:-191.7,11:131.2,13:0,14:0,20:0,42:-30.10},
  15:{1:-83.98,3:-25.36,5:28.60,7:-341.6,9:122.4,15:0,42:-83.98},
  16:{1:-832.2,3:-417.2,5:1025,7:517.3,16:0,42:-832.2},
  20:{1:315.3,3:62.32,5:339.8,7:350.0,9:-297.8,10:25.34,11:660.2,13:664.6,14:0,20:0,21:-201.5,23:-61.70,42:315.3,43:-202.3},
  21:{1:-18.81,2:0,3:-114.1,5:75.49,7:370.7,9:13.89,11:-68.87,13:122.9,20:306.4,21:0,42:-18.81},
  22:{1:53.76,2:0,3:-52.10,5:-225.7,7:-122.4,9:-165.9,22:0,42:53.76},
  23:{1:36.70,2:0,3:79.71,5:742.1,7:-31.09,9:174.6,10:0,11:147.3,13:-48.93,20:-384.0,23:0,42:36.70},
  24:{1:-22.10,2:0,3:-56.08,5:184.4,7:0,9:0,24:0,42:-22.10},
  25:{1:53.76,3:-52.10,5:-225.7,7:-122.4,9:-165.9,11:0,25:0,42:53.76},
  35:{1:-12.97,3:42.70,5:-202.1,7:-397.4,9:-97.27,11:-203.4,35:0,42:-12.97},
  39:{1:-31.95,3:-22.10,5:152.2,7:834.4,9:-123.1,11:61.59,39:0,42:-31.95},
  40:{1:24.82,3:-22.97,5:-150.0,7:185.4,9:-191.7,11:-148.3,40:0,42:24.82},
  42:{1:0,2:0,3:-11.12,4:-69.70,5:156.4,6:16.51,7:300.0,9:26.76,10:505.7,11:114.8,13:83.36,14:-30.10,15:-83.98,16:-832.2,20:315.3,21:-18.81,22:53.76,23:36.70,24:-22.10,25:53.76,35:-12.97,39:-31.95,40:24.82,42:0,43:339.1},
  43:{1:339.1,3:139.8,5:-17.25,7:-118.1,9:0,20:-202.3,43:0,42:339.1},
};

// Decomposition of each solvent into UNIFAC groups
const UNIFAC_DECOMP = {
  methanol:   [['CH3OH',1]],
  ethanol:    [['CH3',1],['CH2',1],['OH',1]],
  isopropanol:[['CH3',2],['CH',1],['OH',1]],
  acetone:    [['CH3',1],['CH3CO',1]],
  ethyl_acetate:[['CH3',1],['CH2',1],['CH3COO',1]],
  benzene:    [['ACH',6]],
  toluene:    [['ACH',5],['ACCH3',1]],
  dcm:        [['CH2Cl2',1]],
  thf:        [['THF',1],['CH2',3]],
  hexane:     [['CH3',2],['CH2',4]],
  heptane:    [['CH3',2],['CH2',5]],
  cyclohexane:[['cCH2',6]],
  butanol:    [['CH3',1],['CH2',3],['OH',1]],
  water:      [['H2O',1]],
  xylene:     [['ACH',4],['ACCH3',2]],
  acetonitrile:[['CH3CN',1]],
  mek:        [['CH3',1],['CH2',1],['CH3CO',1]],
  diethyl_ether:[['CH3',2],['CH2',1],['CH2O',1]],
  dmf:        [['DMF',1]],
  chloroform: [['CHCl3',1]],
  dmso:       [['DMSO',1]],
  acetic_acid:[['CH3',1],['COOH',1]],
  pentane:    [['CH3',2],['CH2',3]],
  methyl_acetate:[['CH3',1],['CH3COO',1]],
  // --- Nouveaux compos√©s ---
  propanol:        [['CH3',1],['CH2',2],['OH',1]],
  sec_butanol:     [['CH3',2],['CH',1],['OH',1]],
  pentanol:        [['CH3',1],['CH2',4],['OH',1]],
  ethylene_glycol: [['CH2',2],['OH',2]],
  octane:          [['CH3',2],['CH2',6]],
  decane:          [['CH3',2],['CH2',8]],
  styrene:         [['ACH',5],['AC',1],['CH=CH',1]],
  ethylbenzene:    [['ACH',5],['ACCH2',1],['CH3',1]],
  isooctane:       [['CH3',5],['CH2',1],['CH',1],['C',1]],
  edc:             [['CH2Cl',2]],
  carbon_tet:      [['CCl4',1]],
  perchloroethylene:[['CCl2',2]],
  chlorobenzene:   [['ACH',5],['ACCl',1]],
  formic_acid:     [['HCOOH',1]],
  propionic_acid:  [['CH3',1],['CH2',1],['COOH',1]],
  aniline:         [['ACH',5],['ACNH2',1]],
  triethylamine:   [['CH3',3],['CH2',2],['CH3N',1]],
};

// UNIFAC activity coefficient calculation
function unifacGamma(k1,k2,x1,T){
  const dec1=UNIFAC_DECOMP[k1],dec2=UNIFAC_DECOMP[k2];
  if(!dec1||!dec2)return[1,1];
  const TK=T+273.15,x2=1-x1;
  if(x1<1e-10||x2<1e-10)return[1,1];

  // Molecular r and q
  function calcRQ(dec){let r=0,q=0;dec.forEach(([g,n])=>{const gp=UNIFAC_GROUPS[g];if(gp){r+=n*gp.R;q+=n*gp.Q}});return{r,q}}
  const rq1=calcRQ(dec1),rq2=calcRQ(dec2);
  const r1=rq1.r,q1=rq1.q,r2=rq2.r,q2=rq2.q;

  // Combinatorial part (Staverman-Guggenheim)
  const rM=x1*r1+x2*r2,qM=x1*q1+x2*q2;
  const phi1=x1*r1/rM,phi2=x2*r2/rM;
  const theta1=x1*q1/qM,theta2=x2*q2/qM;
  const z=10;
  const l1=z/2*(r1-q1)-(r1-1),l2=z/2*(r2-q2)-(r2-1);
  const lnGc1=Math.log(phi1/Math.max(x1,1e-15))+z/2*q1*Math.log(theta1/Math.max(phi1,1e-15))+l1-phi1/Math.max(x1,1e-15)*(x1*l1+x2*l2);
  const lnGc2=Math.log(phi2/Math.max(x2,1e-15))+z/2*q2*Math.log(theta2/Math.max(phi2,1e-15))+l2-phi2/Math.max(x2,1e-15)*(x1*l1+x2*l2);

  // Residual part
  // Collect all groups in the mixture
  function getGroupList(dec){let gl={};dec.forEach(([g,n])=>{const gp=UNIFAC_GROUPS[g];if(gp){const m=gp.main;if(!gl[m])gl[m]={Q:gp.Q,nu:0};gl[m].nu+=n}});return gl}

  function lnGammaRes(decI,x_arr,dec_arr){
    // Collect all main groups in molecule i and in mixture
    let allGroups=new Set();
    dec_arr.forEach((dec,idx)=>{dec.forEach(([g,n])=>{const gp=UNIFAC_GROUPS[g];if(gp)allGroups.add(gp.main)})});
    const groups=[...allGroups];

    // Surface area fractions in mixture and in pure component
    function calcTheta(decList,xList){
      let sumQX={};
      groups.forEach(m=>{sumQX[m]=0});
      decList.forEach((dec,idx)=>{
        dec.forEach(([g,n])=>{
          const gp=UNIFAC_GROUPS[g];
          if(gp&&groups.includes(gp.main))sumQX[gp.main]+=xList[idx]*n*gp.Q;
        });
      });
      let totalQ=groups.reduce((s,m)=>s+sumQX[m],0);
      let theta={};groups.forEach(m=>{theta[m]=totalQ>0?sumQX[m]/totalQ:0});
      return theta;
    }

    const thetaMix=calcTheta(dec_arr,x_arr);
    const thetaPure=calcTheta([decI],[1]);

    // Psi matrix (temperature-dependent)
    function psi(m,n){
      if(m===n)return 1;
      const amn=UNIFAC_A[m]&&UNIFAC_A[m][n];
      if(amn===undefined)return 1;
      return Math.exp(-amn/TK);
    }

    // ln Gamma_k for each group in mixture and pure
    function lnGammaK(theta,grpMain){
      const Qk=(() => {
        for(const[g,gp] of Object.entries(UNIFAC_GROUPS)){if(gp.main===grpMain)return gp.Q}return 0;
      })();
      let sum1=0;
      groups.forEach(m=>{sum1+=theta[m]*psi(m,grpMain)});
      let sum2=0;
      groups.forEach(m=>{
        let denom=0;groups.forEach(n=>{denom+=theta[n]*psi(n,m)});
        sum2+=theta[m]*psi(grpMain,m)/Math.max(denom,1e-15);
      });
      return Qk*(1-Math.log(Math.max(sum1,1e-15))-sum2);
    }

    let lnGR=0;
    decI.forEach(([g,n])=>{
      const gp=UNIFAC_GROUPS[g];
      if(gp){
        const lnGk_mix=lnGammaK(thetaMix,gp.main);
        const lnGk_pure=lnGammaK(thetaPure,gp.main);
        lnGR+=n*(lnGk_mix-lnGk_pure);
      }
    });
    return lnGR;
  }

  const lnGr1=lnGammaRes(dec1,[x1,x2],[dec1,dec2]);
  const lnGr2=lnGammaRes(dec2,[x1,x2],[dec1,dec2]);

  const g1=Math.exp(Math.min(lnGc1+lnGr1,10));
  const g2=Math.exp(Math.min(lnGc2+lnGr2,10));
  return[Math.max(g1,.01),Math.max(g2,.01)];
}

function hasUNIFAC(k1,k2){return !!(UNIFAC_DECOMP[k1]&&UNIFAC_DECOMP[k2])}

function getModel(k1,k2,uc){
  if(uc==='raoult')return'raoult';
  if(uc==='nrtl')return getNRTL(k1,k2)?'nrtl':(hasUNIFAC(k1,k2)?'unifac':'raoult');
  if(uc==='unifac')return hasUNIFAC(k1,k2)?'unifac':'raoult';
  // auto: NRTL > UNIFAC > Raoult
  if(getNRTL(k1,k2))return'nrtl';
  if(hasUNIFAC(k1,k2))return'unifac';
  return'raoult';
}

function gammaAt(k1,k2,x,T,model){
  if(model==='nrtl')return nrtlGamma(k1,k2,x,T);
  if(model==='unifac')return unifacGamma(k1,k2,x,T);
  return[1,1];
}

function bubT(s1,s2,k1,k2,x,P,model){
  let T=s1.tb*x+s2.tb*(1-x);
  for(let i=0;i<100;i++){
    const g=gammaAt(k1,k2,x,T,model);
    const f=antP(s1,T)*g[0]*x+antP(s2,T)*g[1]*(1-x)-P;
    const dT=.01;
    const g2=gammaAt(k1,k2,x,T+dT,model);
    const fp=(antP(s1,T+dT)*g2[0]*x+antP(s2,T+dT)*g2[1]*(1-x)-P-f)/dT;
    if(Math.abs(fp)<1e-12)break;
    T-=f/fp;if(Math.abs(f/fp)<.0005)break;
  }
  return T;
}

function vleY(s1,s2,k1,k2,x,P,model){
  if(x<=0)return 0;if(x>=1)return 1;
  const T=bubT(s1,s2,k1,k2,x,P,model);
  const g=gammaAt(k1,k2,x,T,model);
  return Math.min(Math.max(x*antP(s1,T)*g[0]/P,0),1);
}

function relAlpha(s1,s2,k1,k2,x,P,model){
  const T=bubT(s1,s2,k1,k2,x,P,model);
  const g=gammaAt(k1,k2,x,T,model);
  const denom=antP(s2,T)*g[1];
  return denom>0?(antP(s1,T)*g[0])/denom:10;
}

function avgAlpha(s1,s2,k1,k2,P,model){
  return Math.pow(relAlpha(s1,s2,k1,k2,.1,P,model)*relAlpha(s1,s2,k1,k2,.5,P,model)*relAlpha(s1,s2,k1,k2,.9,P,model),1/3);
}

function detectAzeotrope(s1,s2,k1,k2,P,model){
  let azeos=[];
  for(let i=1;i<99;i++){
    const x0=i/100,x1=(i+1)/100;
    const d0=vleY(s1,s2,k1,k2,x0,P,model)-x0;
    const d1=vleY(s1,s2,k1,k2,x1,P,model)-x1;
    if(d0*d1<0){
      let lo=x0,hi=x1;
      for(let j=0;j<50;j++){const m=(lo+hi)/2;(vleY(s1,s2,k1,k2,m,P,model)-m)*d0>0?lo=m:hi=m}
      const xa=(lo+hi)/2;azeos.push({x:xa,T:bubT(s1,s2,k1,k2,xa,P,model)});
    }
  }
  return azeos;
}

function fenske(a,xD,xW){return Math.log((xD/(1-xD))*((1-xW)/xW))/Math.log(a)}
// Rigorous Nmin via total reflux stepping on actual VLE curve
// Returns fractional stage count for use in Gilliland correlation
// Falls back to classic Fenske if azeotrope prevents convergence
function fenskeVLE(s1,s2,k1,k2,xD,xW,P,model){
  const alphaFallback=Math.pow(relAlpha(s1,s2,k1,k2,.1,P,model)*relAlpha(s1,s2,k1,k2,.5,P,model)*relAlpha(s1,s2,k1,k2,.9,P,model),1/3);
  let xc=xD,n=0,prevX=xD;
  for(let i=0;i<100;i++){
    const y=xc;
    let lo=0,hi=Math.min(xc+1e-6,1);
    for(let j=0;j<60;j++){const mid=(lo+hi)/2;vleY(s1,s2,k1,k2,mid,P,model)>y?hi=mid:lo=mid}
    const xv=(lo+hi)/2;
    n++;
    // If step doesn't progress (azeotrope or VLE tangent), fall back
    if(Math.abs(xv-xc)<1e-8||xv>=prevX){return fenske(alphaFallback,xD,xW)}
    if(xv<=xW){
      if(xc>xW){const frac=(xc-xW)/(xc-xv);n=n-1+frac;}
      break;
    }
    prevX=xc;xc=xv;
  }
  if(n>=100)return fenske(alphaFallback,xD,xW);
  return n;
}
function underwood(a,xF,xD){return Math.max((1/(a-1))*(xD/xF-a*(1-xD)/(1-xF)),.1)}
function gilliland(Nm,R,Rm){const X=(R-Rm)/(R+1),Y=1-Math.exp((1+54.4*X)/(11+117.2*X)*((X-1)/Math.sqrt(X)));return Math.max((Nm+Y)/(1-Y),Nm+1)}

// ===== UI HELPERS =====
function rc(v,l,u){return'<div class="ri"><div class="rv">'+v+'</div><div class="ru">'+u+'</div><div class="rl">'+l+'</div></div>'}
const tabN={input:'Saisie',results:'R√©sultats',pid:'P&ID',curves:'Courbes',anim:'Animation',mccabe:'McCabe-Thiele',report:'Rapport'};
function sp(id){document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));document.getElementById('p-'+id).classList.add('active');document.querySelectorAll('.nav-tab').forEach(t=>t.classList.toggle('active',t.textContent.trim()===tabN[id]))}
function $(id){return document.getElementById(id).value}

// Init dropdowns
(function(){
  const ls=document.getElementById('lc'),hs=document.getElementById('hc');
  Object.entries(S).sort((a,b)=>a[1].tb-b[1].tb).forEach(([k,s])=>{ls.add(new Option(s.n+' ('+s.tb+'¬∞C)',k));hs.add(new Option(s.n+' ('+s.tb+'¬∞C)',k))});
  ls.value='ethanol';hs.value='water';umi();
})();

function umi(){
  const lk=$('lc'),hk=$('hc'),thm=$('thModel');
  if(!lk||!hk||lk===hk){document.getElementById('molInfo').style.display='none';document.getElementById('azeoInfo').style.display='none';return}
  const l=S[lk],h=S[hk],P=+$('P');
  if(l.tb>=h.tb){document.getElementById('molInfo').style.display='block';document.getElementById('molInfoGrid').innerHTML=rc('‚ö†Ô∏è','L√©ger doit avoir Tb < lourd','');document.getElementById('azeoInfo').style.display='none';return}
  const model=getModel(lk,hk,thm),a=avgAlpha(l,h,lk,hk,P,model);
  const nrtlOk=!!getNRTL(lk,hk);
  let mTag=model==='nrtl'?'<span class="tag tag-nrtl">NRTL</span>':model==='unifac'?'<span class="tag tag-unifac">UNIFAC</span>':'<span class="tag tag-raoult">Raoult</span>';
  if(!nrtlOk&&!hasUNIFAC(lk,hk)&&thm!=='raoult')mTag+=' <span style="font-size:.75rem;color:var(--t3)">(aucun mod√®le non-id√©al disponible)</span>';
  document.getElementById('molInfo').style.display='block';
  document.getElementById('molInfoGrid').innerHTML=rc(l.tb+'¬∞C','Tb '+l.n,'')+rc(h.tb+'¬∞C','Tb '+h.n,'')+rc(a.toFixed(2),'Œ± moyen','')+
    '<div class="ri" style="text-align:left;padding:.8rem"><div class="rl" style="margin-bottom:.3rem">Mod√®le actif</div><div style="font-size:.9rem">'+mTag+'</div></div>';
  const azeos=detectAzeotrope(l,h,lk,hk,P,model);
  const aDiv=document.getElementById('azeoInfo');
  if(azeos.length>0){
    aDiv.style.display='block';
    aDiv.innerHTML='<div class="ib">üíß <strong>Az√©otrope d√©tect√© !</strong> '+azeos.map(a=>'x‚ÇÅ='+a.x.toFixed(3)+' √† T='+a.T.toFixed(1)+'¬∞C').join(', ')+'. S√©paration compl√®te impossible au-del√† de ce point.</div>';
  } else aDiv.style.display='none';
}

// ===== MAIN CALCULATION =====
function calc(){
  const lk=$('lc'),hk=$('hc');
  if(!lk||!hk||lk===hk){alert('S√©lectionnez deux compos√©s diff√©rents.');return}
  const l=S[lk],h=S[hk];
  if(l.tb>=h.tb){alert('Le compos√© l√©ger doit avoir Tb < lourd.');return}
  document.getElementById('ld').classList.add('show');
  document.getElementById('ldT').textContent='Calculs thermodynamiques en cours...';
  setTimeout(()=>{try{doCalc(l,h,lk,hk)}catch(e){alert('Erreur: '+e.message);console.error(e)}document.getElementById('ld').classList.remove('show')},200);
}

function doCalc(l,h,lk,hk){
  const xF=+$('xF'),xD=+$('xD'),xW=+$('xW'),P=+$('P'),vF=+$('vF'),RRm=+$('RR'),
    flPct=+$('flood')/100,eta=+$('eff'),intType=$('int'),mat=$('mat'),rpol=$('rpol'),thm=$('thModel');
  const model=getModel(lk,hk,thm);
  const azeos=detectAzeotrope(l,h,lk,hk,P,model);
  if(azeos.length>0){
    const azX=azeos[0].x;
    if((xF<azX&&xD>azX)||(xF>azX&&xD<azX)){
      if(!confirm('Az√©otrope √† x‚ÇÅ='+azX.toFixed(3)+'. xD='+xD+' d√©passe cette limite. Continuer?'))return;
    }
  }
  const MWf=xF*l.mw+(1-xF)*h.mw,rhoF=xF*l.d+(1-xF)*h.d,mF=vF*rhoF,nF=mF/MWf*1000;
  const alpha=avgAlpha(l,h,lk,hk,P,model);
  // Use rigorous VLE-based Nmin (total reflux stepping) for consistency with McCabe
  const NminVLE=fenskeVLE(l,h,lk,hk,xD,xW,P,model);
  const Nmin=NminVLE;
  // Rmin: VLE-based for all models
  // For q=1 (saturated liquid feed), pinch is at (xF, y*(xF))
  // Rmin = (xD - y*) / (y* - xF)
  // Also check tangent pinch in enriching section (xF to xD)
  const yStarF=vleY(l,h,lk,hk,xF,P,model);
  let Rmin=(yStarF>xF)?(xD-yStarF)/(yStarF-xF):underwood(alpha,xF,xD);
  // Check tangent pinch in enriching section
  let RminTang=0;
  for(let i=1;i<200;i++){
    const xi=xF+(xD-xF-0.001)*i/200;
    const yi=vleY(l,h,lk,hk,xi,P,model);
    if(yi>xi&&yi<xD){const Ri=(xD-yi)/(yi-xi);if(Ri>RminTang)RminTang=Ri}
  }
  Rmin=Math.max(Rmin,RminTang,0.1);
  const R=Rmin*RRm;
  const Nth=gilliland(Nmin,R,Rmin),Nact=Math.ceil(Nth/eta);
  const hetp={sieve:.45,valve:.40,structured:.30,random:.50}[intType]||.35;
  const Hpack=Nth*hetp,Htot=Hpack+1.5+1.0;
  const nD=nF*(xF-xW)/(xD-xW),nW=nF-nD;
  const MWd=xD*l.mw+(1-xD)*h.mw,MWw=xW*l.mw+(1-xW)*h.mw,rhoD=xD*l.d+(1-xD)*h.d;
  const mD=nD*MWd/1000,mW=nW*MWw/1000,vD=mD/rhoD;
  const Tfeed=25,Tbub=bubT(l,h,lk,hk,xF,P,model),cpF=xF*l.cp+(1-xF)*h.cp;
  const Qsen=mF*cpF*(Tbub-Tfeed),hvAvg=xF*l.hv+(1-xF)*h.hv;
  const totVapMol=nD*(R+1),Qvap=totVapMol*hvAvg/1000,Qtot=Qsen+Qvap;
  const tBatch=Math.max(2,Math.min(8,vF/200)),Qreb=Qtot/(tBatch*3600),Qcond=Qreb*.95;
  const Ttop=bubT(l,h,lk,hk,xD,P,model),Tbot=bubT(l,h,lk,hk,xW,P,model);
  const rhoV=P*MWd/(8.314*(Ttop+273.15)),rhoL=rhoD*1000;
  const Csb={structured:.04,random:.035,sieve:.03,valve:.032}[intType]||.04;
  const Uf=Csb*Math.sqrt((rhoL-rhoV)/rhoV),Uop=Uf*flPct;
  const Vmr=totVapMol/(tBatch*3600),Vvol=Vmr*8.314*(Ttop+273.15)/(P*1000);
  const Acol=Vvol/Math.max(Uop,.001),Dc=Math.sqrt(4*Acol/Math.PI);
  const stdD=[.05,.08,.10,.15,.20,.25,.30,.40,.50,.60,.80,1.0,1.2,1.5,2.0],Dstd=stdD.find(d=>d>=Dc)||Math.ceil(Dc*100)/100;
  const dPm={structured:.3,random:.5,sieve:.7,valve:.6}[intType]||.5,dPtot=dPm*Hpack;
  const stT=143,stH=2133,stFlow=Qreb/stH*3600,cwIn=25,cwOut=40,cwFlow=Qcond/(4.18*(cwOut-cwIn))*3600;
  const lmtdC=((Ttop-cwOut)-(Ttop-cwIn))/Math.log(Math.max((Ttop-cwOut)/(Ttop-cwIn),.01)),Acond=Qreb>0?Qcond*1000/(800*Math.max(lmtdC,1)):0;
  const lmtdR=Math.max(stT-Tbot,1),Areb=Qreb>0?Qreb*1000/(1000*lmtdR):0;

  // Dynamic simulation (Rayleigh)
  const steps=100,sim=[];let Wc=nF,xc=xF;
  for(let i=0;i<=steps;i++){
    const tf=i/steps,tm=tf*tBatch*60;
    const ye=vleY(l,h,lk,hk,xc,P,model),Tb=bubT(l,h,lk,hk,xc,P,model);
    const Tt=bubT(l,h,lk,hk,Math.min(ye,xD),P,model);
    const xDi=rpol==='variable'?xD:Math.min(ye,1);
    const hvi=xc*l.hv+(1-xc)*h.hv,Qi=Qreb*(hvi/hvAvg);
    const Dcol=(nF-Wc)*MWd/1000/Math.max(rhoD,.01);
    sim.push({t:tm,xs:xc,yv:ye,xDi,Tb,Tt,Qr:Qi,Qc:Qi*.95,Ra:R,Dr:Vmr/(R+1)*MWd/1000*3600,Dv:Dcol,Wr:Wc*MWw/1000});
    if(i<steps&&xc>xW){const dx=(xF-xW)/steps,dW=Wc*dx/Math.max(ye-xc,.001);Wc=Math.max(Wc-Math.abs(dW),nW);xc=Math.max(xc-dx,xW)}
  }

  // Safety
  const saf=[],allH=[...new Set([...l.haz,...h.haz])];
  if(allH.some(h=>h.toLowerCase().includes('flamm'))){saf.push("üî• ATEX Zone 1 ‚Äî installation Ex");saf.push("D√©tection LEL + asservissement")}
  if(allH.some(h=>h.toLowerCase().includes('oxique')))saf.push("‚ò†Ô∏è VME √† respecter ‚Äî ventilation m√©canique locale");
  if(allH.some(h=>h.toLowerCase().includes('cmr')))saf.push("‚ö†Ô∏è CMR ‚Äî substitution prioritaire");
  if(allH.some(h=>h.toLowerCase().includes('eroxy')))saf.push("‚ö†Ô∏è Peroxydes ‚Äî inhibiteur + contr√¥le r√©gulier");
  if(allH.some(h=>h.toLowerCase().includes('corros')))saf.push("‚ö†Ô∏è Corrosif ‚Äî compatibilit√© mat√©riaux");
  saf.push('PSV tarage '+(P*1.1).toFixed(0)+' kPa');
  saf.push('R√©tention ‚â• 110% volume bouilleur');
  saf.push('TI t√™te/pied, PI t√™te, LI bouilleur, FCV reflux/distillat');

  R_={l,h,lk,hk,xF,xD,xW,P,R,Rmin,alpha,Nmin,Nth,Nact,eta,hetp,Hpack,Htot,Dstd,Dc,mF,nF,mD,vD,mW,nD,nW,Qsen,Qvap,Qtot,Qreb,Qcond,tBatch,dPtot,Ttop,Tbot,stFlow,cwFlow,Acond,Areb,intType,mat,rpol,vF,MWf,rhoF,sim,saf,allH,Tbub,stT,cwIn,cwOut,MWd,rhoD,model,azeos};
  showResults();drawPID();drawCharts();drawAnim(0);drawMcCabe();genReport();sp('results');
}

function showResults(){const r=R_;
  const mT=r.model==='nrtl'?'<span class="tag tag-nrtl">NRTL</span>':r.model==='unifac'?'<span class="tag tag-unifac">UNIFAC</span>':'<span class="tag tag-raoult">Raoult</span>';
  const aT=r.azeos.length?'<span class="tag tag-azeo">Az√©otrope</span>':'';
  document.getElementById('rModelTag').innerHTML='<div class="ib" style="margin-bottom:1rem">'+mT+' '+aT+' ¬∑ <strong>'+r.l.n+'</strong> / <strong>'+r.h.n+'</strong> ¬∑ Œ±='+r.alpha.toFixed(2)+'</div>';
  document.getElementById('rCol').innerHTML=rc((r.Dstd*1000).toFixed(0),'Diam√®tre','mm')+rc(r.Htot.toFixed(1),'Hauteur totale','m')+rc(r.Hpack.toFixed(1),'Hauteur garnissage','m')+rc(Math.ceil(r.Nth),'Plateaux th√©oriques','')+rc(r.Nact,'Plateaux r√©els','')+rc(r.alpha.toFixed(2),'Œ± moyen','')+rc((r.hetp*100).toFixed(0),'HETP','cm')+rc(r.dPtot.toFixed(1),'ŒîP totale','kPa');
  document.getElementById('rTh').innerHTML=rc(r.Qreb.toFixed(1),'Bouilleur','kW')+rc(r.Qcond.toFixed(1),'Condenseur','kW')+rc((r.Qtot/1000).toFixed(1),'√ânergie batch','MJ')+rc(r.Ttop.toFixed(1),'T¬∞ t√™te','¬∞C')+rc(r.Tbot.toFixed(1),'T¬∞ pied','¬∞C');
  document.getElementById('rMa').innerHTML=rc(r.mF.toFixed(1),'Charge','kg')+rc(r.mD.toFixed(1),'Distillat','kg')+rc(r.vD.toFixed(1),'Vol. distillat','L')+rc(r.mW.toFixed(1),'R√©sidu','kg')+rc(r.R.toFixed(2),'Reflux R','')+rc((r.tBatch*60).toFixed(0),'Dur√©e','min');
  document.getElementById('rAux').innerHTML=rc(r.stFlow.toFixed(1),'Vapeur 3 bar','kg/h')+rc(r.cwFlow.toFixed(0),'Eau refroid.','kg/h')+rc(r.Acond.toFixed(2),'S condenseur','m¬≤')+rc(r.Areb.toFixed(2),'S bouilleur','m¬≤');
  document.getElementById('rSaf').innerHTML=r.saf.map(s=>'<div style="padding:.45rem 0;border-bottom:1px solid var(--brd);font-size:.88rem">'+s+'</div>').join('');
}

// ===== P&ID =====
function drawPID(){const r=R_,svg=document.getElementById('pidSvg');
// === ISO 14617 / ISA 5.1 P&ID ===
const BK='#222',GR='#555',LG='#888',PL='#1565c0',VL='#c62828',CL='#2e7d32',SG='#d32f2f';
const LW=1.5,LWfine=1,LWutil=1,LWsig=0.7; // line weights
function txt(x,y,s,sz,o){o=o||{};return`<text x="${x}" y="${y}" font-family="Arial,sans-serif" font-size="${sz}" fill="${o.c||BK}" text-anchor="${o.a||'middle'}"${o.b?' font-weight="bold"':''}>${s}</text>`}
function ln(x1,y1,x2,y2,c,w,o){return`<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${c}" stroke-width="${w}"${o?' '+o:''}/>`}
function pl(pts,c,w,o){return`<polyline points="${pts}" fill="none" stroke="${c}" stroke-width="${w}"${o?' '+o:''}/>`}
function rct(x,y,w,h,o){o=o||{};return`<rect x="${x}" y="${y}" width="${w}" height="${h}" rx="${o.r||0}" fill="${o.f||'none'}" stroke="${o.s||BK}" stroke-width="${o.sw||LW}"/>`}
// ISA 5.1 instrument bubble (r=11)
function instr(x,y,tag,loop,panel){
  let s=`<circle cx="${x}" cy="${y}" r="11" fill="#fff" stroke="${BK}" stroke-width="${LW}"/>`;
  if(panel)s+=ln(x-11,y,x+11,y,BK,0.7);
  s+=txt(x,y-2,tag,6.5,{b:true})+txt(x,y+6.5,loop,5.5,{c:GR});return s;
}
// Control valve (bowtie, size 7)
function cv(x,y,tag,hz){
  const a=7,b=6;let s='';
  if(hz){s+=`<polygon points="${x-a},${y-b} ${x},${y} ${x-a},${y+b}" fill="none" stroke="${BK}" stroke-width="${LW}"/><polygon points="${x+a},${y-b} ${x},${y} ${x+a},${y+b}" fill="none" stroke="${BK}" stroke-width="${LW}"/>`;s+=ln(x,y,x,y-12,BK,LWfine)}
  else{s+=`<polygon points="${x-b},${y-a} ${x},${y} ${x+b},${y-a}" fill="none" stroke="${BK}" stroke-width="${LW}"/><polygon points="${x-b},${y+a} ${x},${y} ${x+b},${y+a}" fill="none" stroke="${BK}" stroke-width="${LW}"/>`;s+=ln(x,y,x+12,y,BK,LWfine)}
  s+=txt(x,y+(hz?18:20),tag,5.5,{c:GR});return s;
}
// Manual valve (filled bowtie, size 5)
function mv(x,y){return`<polygon points="${x-5},${y-4} ${x},${y} ${x-5},${y+4}" fill="${BK}" stroke="${BK}" stroke-width="0.8"/><polygon points="${x+5},${y-4} ${x},${y} ${x+5},${y+4}" fill="${BK}" stroke="${BK}" stroke-width="0.8"/>`}
// PSV
function psv(x,y,tag,sp){
  let s=`<polygon points="${x-7},${y} ${x},${y-11} ${x+7},${y}" fill="none" stroke="${SG}" stroke-width="${LW}"/>`;
  s+=ln(x,y-11,x,y-20,SG,LW)+ln(x-4,y-20,x+4,y-20,SG,1.8)+ln(x-3,y-23,x+3,y-23,SG,1.2);
  s+=txt(x,y+10,tag,6.5,{c:SG,b:true})+txt(x,y+18,sp,5.5,{c:SG});return s;
}
// Pump (r=13)
function pump(x,y,tag){
  let s=`<circle cx="${x}" cy="${y}" r="13" fill="#fff" stroke="${BK}" stroke-width="${LW}"/>`;
  s+=`<polygon points="${x-5},${y-7} ${x-5},${y+7} ${x+8},${y}" fill="none" stroke="${BK}" stroke-width="${LWfine}"/>`;
  s+=txt(x,y+24,tag,7,{b:true});return s;
}
// HX (shell & tube)
function hx(x,y,tag,duty,hz){
  let s='';const rA=hz?35:25,rB=hz?22:35;
  s+=`<ellipse cx="${x}" cy="${y}" rx="${rA}" ry="${rB}" fill="#fff" stroke="${BK}" stroke-width="${LW}"/>`;
  if(hz){s+=ln(x-8,y-rB,x-8,y+rB,BK,0.6)+ln(x+8,y-rB,x+8,y+rB,BK,0.6)}
  else{s+=ln(x-rA,y-8,x+rA,y-8,BK,0.6)+ln(x-rA,y+8,x+rA,y+8,BK,0.6)}
  s+=txt(x,y-2,tag,7.5,{b:true})+txt(x,y+9,duty,5.5,{c:GR});return s;
}
// Tank
function tank(x,y,w,h,tag,desc,vol){
  let s=`<path d="M${x},${y+h} L${x},${y+10} Q${x},${y} ${x+w/2},${y} Q${x+w},${y} ${x+w},${y+10} L${x+w},${y+h} Z" fill="#fff" stroke="${BK}" stroke-width="${LW}"/>`;
  s+=txt(x+w/2,y+h/2-4,tag,8.5,{b:true})+txt(x+w/2,y+h/2+9,desc,6.5,{c:GR});
  if(vol)s+=txt(x+w/2,y+h/2+19,vol,5.5,{c:LG});return s;
}
// Drum (horizontal)
function drum(x,y,w,h,tag,desc){
  const r2=h/2;
  let s=`<path d="M${x+r2},${y} L${x+w-r2},${y} Q${x+w},${y} ${x+w},${y+r2} Q${x+w},${y+h} ${x+w-r2},${y+h} L${x+r2},${y+h} Q${x},${y+h} ${x},${y+r2} Q${x},${y} ${x+r2},${y} Z" fill="#fff" stroke="${BK}" stroke-width="${LW}"/>`;
  s+=txt(x+w/2,y+h/2-1,tag,7.5,{b:true})+txt(x+w/2,y+h/2+10,desc,6,{c:GR});return s;
}
// Column
function column(x,y,w,h,tag,specs,np){
  let s=`<rect x="${x}" y="${y}" width="${w}" height="${h}" rx="5" fill="#fff" stroke="${BK}" stroke-width="2"/>`;
  s+=`<path d="M${x},${y+5} Q${x+w/2},${y-6} ${x+w},${y+5}" fill="none" stroke="${BK}" stroke-width="2"/>`;
  s+=`<path d="M${x},${y+h-5} Q${x+w/2},${y+h+6} ${x+w},${y+h-5}" fill="none" stroke="${BK}" stroke-width="2"/>`;
  const nd=Math.min(np||6,14),sp=(h-30)/nd;
  for(let i=1;i<=nd;i++){const ty=y+12+i*sp;s+=ln(x+5,ty,x+w-5,ty,'#ccc',0.5);s+=ln(x+w-12,ty,x+w-12,ty-sp*.45,'#ccc',0.5)}
  s+=txt(x+w/2,y-14,tag,10,{b:true})+txt(x+w/2,y-4,specs,6.5,{c:GR});return s;
}
// Lines
function proc(pts,c){return pl(pts,c||BK,LW,'marker-end="url(#arr)"')}
function util(pts,c){return pl(pts,c||LG,LWutil,'stroke-dasharray="6,3"')}
function sig(pts){return pl(pts,'#444',LWsig,'stroke-dasharray="4,2"')}

// ========= BUILD SVG =========
let s=`<defs>
<marker id="arr" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto" markerUnits="userSpaceOnUse"><polygon points="0 0,8 3,0 6" fill="${BK}"/></marker>
<marker id="arrB" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto" markerUnits="userSpaceOnUse"><polygon points="0 0,8 3,0 6" fill="${PL}"/></marker>
<marker id="arrR" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto" markerUnits="userSpaceOnUse"><polygon points="0 0,8 3,0 6" fill="${VL}"/></marker>
</defs>`;

// Border & title block
s+=rct(5,5,1390,890,{s:'#444',sw:1.5});
s+=rct(5,840,1390,55,{f:'#f9f9f9',s:'#444',sw:1});
s+=ln(700,840,700,895,'#444',0.7)+ln(1050,840,1050,895,'#444',0.7);
s+=txt(352,856,'P&ID ‚Äî DISTILLATION BATCH',12,{b:true});
s+=txt(352,870,r.l.n+' / '+r.h.n+' ‚Äî '+r.model.toUpperCase()+' ‚Äî P='+(r.P/1000).toFixed(2)+' bar',8,{c:GR});
s+=txt(352,882,'xF='+r.xF+'  xD='+r.xD+'  xW='+r.xW+'  R='+r.R.toFixed(2),7,{c:LG});
s+=txt(875,856,'DistillAI v2',9,{b:true})+txt(875,870,'ISO 14617 ¬∑ ISA 5.1',7,{c:GR})+txt(875,882,new Date().toLocaleDateString('fr-FR'),7,{c:LG});
s+=txt(1220,856,'R√©v. 0',8,{b:true})+txt(1220,870,'N.T.S.',7,{c:GR})+txt(1220,882,'Feuille 1/1',7,{c:LG});

// ===== LAYOUT COORDINATES =====
const CX=460,CY=160,CW=55,CH=360;        // Column
const ErebX=460,ErebY=620;                 // Reboiler
const EcondX=720,EcondY=80;                // Condenser
const DrumX=900,DrumY=140;                 // Reflux drum center
const T1X=60,T1Y=310;                      // Feed tank
const T2X=1210,T2Y=250;                    // Distillate tank
const T3X=760,T3Y=660;                     // Residue tank
const P1X=220,P1Y=420;                     // Feed pump
const P2X=1040,P2Y=260;                    // Reflux pump
const Np=Math.ceil(r.Nth)||8;
const TEX=P2X+45,TEY=P2Y;                 // Tee after pump
const DVX=(TEX+T2X-55)/2;                 // Distillate valve X
const rfY=CY+30;                          // Reflux entry Y

// ====================================================================
// LAYER 1: BLUE/COLORED LINES ‚Äî drawn first so they appear BEHIND black
// ====================================================================
// Feed line: T-101 ‚Üí MV ‚Üí P-101 ‚Üí column (blue)
s+=pl(`${T1X+100},${T1Y+90} ${P1X-18},${T1Y+90} ${P1X-18},${P1Y-1}`,PL,LW,'marker-end="url(#arrB)"');
s+=pl(`${P1X+14},${P1Y} ${P1X+50},${P1Y} ${P1X+50},${CY+CH/2} ${CX+1},${CY+CH/2}`,PL,LW,'marker-end="url(#arrB)"');
// Reflux line: tee ‚Üí down ‚Üí enters column side (blue) ‚Äî BEHIND black condensate
s+=pl(`${TEX},${TEY} ${TEX},${rfY} ${CX+CW+1},${rfY}`,PL,LW,'marker-end="url(#arrB)"');
// Distillate line: tee ‚Üí right ‚Üí T-102 (blue)
s+=pl(`${TEX},${TEY} ${T2X-55},${TEY} ${T2X-55},${T2Y+1}`,PL,LW,'marker-end="url(#arrB)"');

// ====================================================================
// LAYER 2: UTILITY LINES (dashed)
// ====================================================================
s+=util(`${ErebX-80},${ErebY+16} ${ErebX-36},${ErebY+16}`,VL);
s+=util(`${ErebX+36},${ErebY+16} ${ErebX+80},${ErebY+16}`,VL);
s+=util(`${EcondX-8},${EcondY-23} ${EcondX-8},${EcondY-42}`,CL);
s+=util(`${EcondX+8},${EcondY-23} ${EcondX+8},${EcondY-42}`,CL);

// ====================================================================
// LAYER 3: BLACK PROCESS LINES ‚Äî on top of blue
// ====================================================================
s+=pl(`${CX+CW/2},${CY+CH+6} ${CX+CW/2},${ErebY-23}`,BK,LW,'marker-end="url(#arr)"');
s+=pl(`${ErebX+36},${ErebY-15} ${CX+CW+14},${ErebY-15} ${CX+CW+14},${CY+CH-25}`,BK,LW,'marker-end="url(#arr)"');
s+=pl(`${CX+CW/2},${CY-6} ${CX+CW/2},${EcondY} ${EcondX-36},${EcondY}`,BK,LW,'marker-end="url(#arr)"');
s+=pl(`${EcondX+36},${EcondY} ${DrumX-55},${EcondY} ${DrumX-55},${DrumY+1}`,BK,LW,'marker-end="url(#arr)"');
s+=pl(`${DrumX},${DrumY+42} ${DrumX},${P2Y} ${P2X-14},${P2Y}`,BK,LW,'marker-end="url(#arr)"');
s+=ln(P2X+14,P2Y,TEX,TEY,BK,LW);
s+=`<circle cx="${TEX}" cy="${TEY}" r="2.5" fill="${BK}"/>`;
s+=ln(DrumX+55,DrumY+8,DrumX+72,DrumY+8,BK,LWfine);
s+=pl(`${CX+CW/2-12},${CY+CH+6} ${CX+CW/2-12},${CY+CH+30} ${T3X},${CY+CH+30} ${T3X},${T3Y+1}`,'#795548',LW,'marker-end="url(#arr)"');

// ====================================================================
// LAYER 4: SIGNAL LINES (dashed thin)
// ====================================================================
const i1X=CX-40,i1Y=CY+50;
const i2X=CX-40,i2Y=CY+CH-50;
const ipX=CX-40,ipY=CY+110;
const ilX=DrumX+65,ilY=DrumY+21;
const ifX=P1X+50,ifY=P1Y-28;
s+=sig(`${i1X},${i1Y+12} ${i1X},${CY+70} ${TEX+12},${CY+70}`);
s+=sig(`${i2X},${i2Y+12} ${i2X},${ErebY+40} ${ErebX-52},${ErebY+40} ${ErebX-52},${ErebY+28}`);
s+=sig(`${ilX},${ilY+12} ${ilX},${TEY+22} ${DVX},${TEY+22} ${DVX},${TEY+12}`);

// ====================================================================
// LAYER 5: EQUIPMENT (white fills on top of all lines)
// ====================================================================
s+=tank(T1X,T1Y,100,120,'T-101','Bac de charge',r.vF+' L');
s+=tank(T2X-105,T2Y,100,110,'T-102','Bac distillat',r.vD.toFixed(0)+' L');
s+=tank(T3X-40,T3Y,80,90,'T-103','R√©sidu','');
s+=ln(T1X-6,T1Y+25,T1X-6,T1Y+110,BK,0.7)+ln(T1X-10,T1Y+25,T1X-2,T1Y+25,BK,0.7)+ln(T1X-10,T1Y+110,T1X-2,T1Y+110,BK,0.7);
s+=txt(T1X-16,T1Y+68,'LG',5.5,{c:GR});
s+=column(CX,CY,CW,CH,'C-101','DN'+(r.Dstd*1000).toFixed(0)+' H='+r.Htot.toFixed(1)+'m',Np);
s+=hx(ErebX,ErebY,'E-101',r.Qreb.toFixed(1)+' kW',true);
s+=hx(EcondX,EcondY,'E-102',r.Qcond.toFixed(1)+' kW',true);
s+=drum(DrumX-55,DrumY,110,42,'D-101','Ballon reflux');
s+=pump(P1X,P1Y,'P-101');
s+=pump(P2X,P2Y,'P-102');

// ====================================================================
// LAYER 6: VALVES (on top of lines)
// ====================================================================
s+=mv(T1X+120,T1Y+90);
s+=mv(CX+CW/2+30,CY+CH+30);
s+=cv(TEX,CY+70,'FCV-101',false);
s+=cv(DVX,TEY,'FCV-102',true);
s+=cv(ErebX-52,ErebY+16,'TCV-102',true);

// ====================================================================
// LAYER 7: PSV
// ====================================================================
s+=ln(CX+CW,CY+15,CX+CW+23,CY+15,SG,LW);
s+=ln(CX+CW+23,CY+15,CX+CW+23,CY+12,SG,LW);
s+=psv(CX+CW+30,CY+5,'PSV-101',(r.P*1.1/1000).toFixed(2)+' bar');
s+=ln(CX+CW+30,CY+5-23,CX+CW+30,CY+5-32,SG,LWfine);
s+=txt(CX+CW+30,CY+5-37,'√âvent s√©curit√©',5.5,{c:SG});

// ====================================================================
// LAYER 8: INSTRUMENTS (on top)
// ====================================================================
s+=instr(i1X,i1Y,'TIC','101',true);
s+=ln(CX,i1Y,i1X+12,i1Y,BK,LWfine);
s+=instr(i2X,i2Y,'TIC','102',true);
s+=ln(CX,i2Y,i2X+12,i2Y,BK,LWfine);
s+=instr(ipX,ipY,'PIC','101',true);
s+=ln(CX,ipY,ipX+12,ipY,BK,LWfine);
s+=instr(ilX,ilY,'LIC','101',true);
s+=ln(DrumX+55,ilY,ilX-12,ilY,BK,LWfine);
s+=instr(ifX,ifY,'FI','101',false);
s+=ln(ifX,ifY+12,ifX,P1Y-8,BK,LWfine);
s+=instr(DVX+50,TEY-25,'TI','103',false);
s+=ln(DVX+50,TEY-14,DVX+50,TEY-2,BK,LWfine);

// ====================================================================
// LAYER 9: LABELS & ANNOTATIONS (very top)
// ====================================================================
s+=txt(CX+CW+18,CY+CH-45,'Vapeur',5.5,{c:VL,a:'start'});
s+=txt(ErebX-85,ErebY+12,'Vap. '+r.stT+'¬∞C',5.5,{c:VL,a:'end'});
s+=txt(ErebX+85,ErebY+12,'Condensat',5.5,{c:VL,a:'start'});
s+=txt(EcondX,EcondY-48,'CW '+r.cwIn+'¬∞C/'+r.cwOut+'¬∞C',5.5,{c:CL});
s+=txt(DrumX+76,DrumY+12,'√âvent',5.5,{c:GR,a:'start'});
s+=txt(P1X+55,CY+CH/2-6,'CHARGE',5.5,{c:PL,a:'start'});
s+=txt(P1X+15,P1Y-15,'2"-PL-001',5.5,{c:GR});
s+=txt(CX+CW/2+4,EcondY-8,'4"-PV-001',5.5,{c:GR,a:'start'});
s+=txt(TEX+14,CY+55,'R='+r.R.toFixed(2),5.5,{c:PL,a:'start'});
s+=txt(DVX,TEY-18,'2"-PL-003',5.5,{c:GR});
s+=txt(CX+CW/2+45,CY+CH+24,'2"-PL-004 R√©sidu',5.5,{c:GR,a:'start'});

// ===== LEGEND (compact) =====
const LBX=20,LBY=670,LBW=380,LBH=150;
s+=rct(LBX,LBY,LBW,LBH,{f:'#fafafa',s:'#aaa',sw:0.8,r:3});
s+=txt(LBX+95,LBY+14,'L√âGENDE',8,{b:true});
const legY=LBY+28;
s+=ln(LBX+12,legY,LBX+42,legY,BK,LW);s+=txt(LBX+48,legY+3,'Ligne process',6.5,{a:'start'});
s+=ln(LBX+12,legY+15,LBX+42,legY+15,LG,LWutil,'stroke-dasharray="6,3"');s+=txt(LBX+48,legY+18,'Ligne utilit√©',6.5,{a:'start'});
s+=ln(LBX+12,legY+30,LBX+42,legY+30,'#444',LWsig,'stroke-dasharray="4,2"');s+=txt(LBX+48,legY+33,'Signal',6.5,{a:'start'});
s+=`<circle cx="${LBX+22}" cy="${legY+48}" r="6" fill="#fff" stroke="${BK}" stroke-width="0.8"/>`;s+=txt(LBX+48,legY+51,'Instrument terrain',6.5,{a:'start'});
s+=`<circle cx="${LBX+22}" cy="${legY+63}" r="6" fill="#fff" stroke="${BK}" stroke-width="0.8"/>`;s+=ln(LBX+16,legY+63,LBX+28,legY+63,BK,0.5);s+=txt(LBX+48,legY+66,'Instrument salle contr√¥le',6.5,{a:'start'});
s+=`<polygon points="${LBX+16},${legY+73} ${LBX+22},${legY+79} ${LBX+16},${legY+85}" fill="none" stroke="${BK}" stroke-width="0.8"/><polygon points="${LBX+28},${legY+73} ${LBX+22},${legY+79} ${LBX+28},${legY+85}" fill="none" stroke="${BK}" stroke-width="0.8"/>`;s+=txt(LBX+48,legY+82,'Vanne de r√©gulation',6.5,{a:'start'});
s+=`<polygon points="${LBX+16},${legY+90} ${LBX+22},${legY+95} ${LBX+16},${legY+100}" fill="${BK}"/><polygon points="${LBX+28},${legY+90} ${LBX+22},${legY+95} ${LBX+28},${legY+100}" fill="${BK}"/>`;s+=txt(LBX+48,legY+98,'Vanne manuelle',6.5,{a:'start'});
s+=`<polygon points="${LBX+16},${legY+115} ${LBX+22},${legY+107} ${LBX+28},${legY+115}" fill="none" stroke="${SG}" stroke-width="1"/>`;s+=txt(LBX+48,legY+114,'PSV',6.5,{a:'start'});
// ISA codes (right side of legend)
s+=txt(LBX+250,LBY+14,'ISA 5.1',8,{b:true});
const codes=[['T','Temp√©rature'],['P','Pression'],['L','Niveau'],['F','D√©bit'],['I','Indicateur'],['C','R√©gulateur']];
codes.forEach((c,i)=>{s+=txt(LBX+228,legY+3+i*14,c[0],6.5,{b:true,a:'end'})+txt(LBX+234,legY+3+i*14,c[1],6.5,{a:'start',c:GR})});

svg.innerHTML=s;
}

function dlPID(){const svg=document.getElementById('pidSvg');
const svgData='<?xml version="1.0" encoding="UTF-8"?>\n'+svg.outerHTML;
const b=new Blob([svgData],{type:'image/svg+xml;charset=utf-8'}),a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='PID_DistillAI_ISO14617.svg';a.click()}

function dlPIDpng(){const svg=document.getElementById('pidSvg');
const svgData='<?xml version="1.0" encoding="UTF-8"?>\n'+svg.outerHTML;
const canvas=document.createElement('canvas');canvas.width=2800;canvas.height=1800;
const ctx=canvas.getContext('2d'),img=new Image();
img.onload=function(){ctx.fillStyle='#fff';ctx.fillRect(0,0,2800,1800);ctx.drawImage(img,0,0,2800,1800);
const a=document.createElement('a');a.href=canvas.toDataURL('image/png');a.download='PID_DistillAI_ISO14617.png';a.click()};
img.src='data:image/svg+xml;base64,'+btoa(unescape(encodeURIComponent(svgData)));
}

// ===== CHARTS =====
function drawCharts(){const r=R_,sd=r.sim,t=sd.map(d=>d.t.toFixed(0));
  Object.values(charts).forEach(c=>c&&c.destroy&&c.destroy());
  const o={responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8',font:{family:'DM Sans'}}}},scales:{x:{ticks:{color:'#64748b',font:{family:'Space Mono',size:10}},grid:{color:'#1e293b'}},y:{ticks:{color:'#64748b',font:{family:'Space Mono',size:10}},grid:{color:'#1e293b'}}}};
  const gc=id=>document.getElementById(id);
  charts.comp=new Chart(gc('cComp'),{type:'line',data:{labels:t,datasets:[{label:'x bouilleur',data:sd.map(d=>d.xs),borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,.1)',fill:true,tension:.4,pointRadius:0},{label:'y vapeur',data:sd.map(d=>d.yv),borderColor:'#3b82f6',borderDash:[5,5],tension:.4,pointRadius:0},{label:'xD distillat',data:sd.map(d=>d.xDi),borderColor:'#10b981',tension:.4,pointRadius:0}]},options:{...o,scales:{x:{...o.scales.x,title:{display:true,text:'Temps (min)',color:'#94a3b8'}},y:{...o.scales.y,title:{display:true,text:'Fraction molaire',color:'#94a3b8'},min:0,max:1}}}});
  charts.temp=new Chart(gc('cTemp'),{type:'line',data:{labels:t,datasets:[{label:'T¬∞ pied',data:sd.map(d=>d.Tb),borderColor:'#ef4444',tension:.4,pointRadius:0},{label:'T¬∞ t√™te',data:sd.map(d=>d.Tt),borderColor:'#3b82f6',tension:.4,pointRadius:0}]},options:{...o,scales:{x:{...o.scales.x,title:{display:true,text:'Temps (min)',color:'#94a3b8'}},y:{...o.scales.y,title:{display:true,text:'¬∞C',color:'#94a3b8'}}}}});
  charts.pow=new Chart(gc('cPow'),{type:'line',data:{labels:t,datasets:[{label:'Q bouilleur',data:sd.map(d=>d.Qr),borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,.1)',fill:true,tension:.4,pointRadius:0},{label:'Q condenseur',data:sd.map(d=>d.Qc),borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.1)',fill:true,tension:.4,pointRadius:0}]},options:{...o,scales:{x:{...o.scales.x,title:{display:true,text:'Temps (min)',color:'#94a3b8'}},y:{...o.scales.y,title:{display:true,text:'kW',color:'#94a3b8'}}}}});
  charts.ref=new Chart(gc('cRef'),{type:'line',data:{labels:t,datasets:[{label:'Reflux R',data:sd.map(d=>d.Ra),borderColor:'#f59e0b',tension:.4,pointRadius:0,yAxisID:'y'},{label:'D√©bit dist. (kg/h)',data:sd.map(d=>d.Dr),borderColor:'#10b981',tension:.4,pointRadius:0,yAxisID:'y1'}]},options:{...o,scales:{x:{...o.scales.x,title:{display:true,text:'Temps (min)',color:'#94a3b8'}},y:{type:'linear',position:'left',ticks:{color:'#f59e0b'},grid:{color:'#1e293b'},title:{display:true,text:'R',color:'#f59e0b'}},y1:{type:'linear',position:'right',ticks:{color:'#10b981'},grid:{display:false},title:{display:true,text:'kg/h',color:'#10b981'}}}}});
  charts.vol=new Chart(gc('cVol'),{type:'line',data:{labels:t,datasets:[{label:'Vol. distillat cumul√© (L)',data:sd.map(d=>d.Dv),borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,.15)',fill:true,tension:.4,pointRadius:0}]},options:{...o,scales:{x:{...o.scales.x,title:{display:true,text:'Temps (min)',color:'#94a3b8'}},y:{...o.scales.y,title:{display:true,text:'L',color:'#94a3b8'}}}}});
}

// ===== McCABE-THIELE (SVG interactif avec zoom/pan) =====
let mcData=null; // store computed VLE and steps data

function drawMcCabe(){
  const r=R_;
  // Pre-compute all data
  const sl=r.R/(r.R+1),ic=r.xD/(r.R+1),yqPt=sl*r.xF+ic;
  // VLE curve points
  const vlePts=[];for(let i=0;i<=300;i++){const x=i/300;vlePts.push({x,y:vleY(r.l,r.h,r.lk,r.hk,x,r.P,r.model)})}
  // McCabe stepping ‚Äî proper construction with pinch zone handling
  // The key insight: in a pinch zone, the VLE curve and operating line are
  // very close together, producing many tiny steps that are NOT real theoretical
  // stages ‚Äî they are artifacts of the graphical method hitting a zone where
  // the driving force (y* - y_op) approaches zero. We detect this by measuring
  // the vertical gap (y_VLE - y_op) relative to the overall driving force.
  const steps=[];let xc=r.xD,yc=r.xD,stages=0;
  const maxStages=200;
  const slStr=(yqPt-r.xW)/(r.xF-r.xW); // stripping line slope
  let usedStripping=false,reachedBottom=false,pinchBreak=false;
  // Reference driving force: average gap between VLE and diagonal across the range
  const spanX=r.xD-r.xW;
  let avgGap=0;for(let i=1;i<20;i++){const xi=r.xW+spanX*i/20;avgGap+=vleY(r.l,r.h,r.lk,r.hk,xi,r.P,r.model)-xi}avgGap/=19;
  const pinchThreshold=avgGap*0.015; // step height < 1.5% of avg VLE gap = pinch zone
  for(let i=0;i<maxStages;i++){
    // Horizontal step: find x on VLE curve where y(x)=yc
    let lo=0,hi=Math.min(xc+1e-6,1);
    for(let j=0;j<60;j++){const mid=(lo+hi)/2;vleY(r.l,r.h,r.lk,r.hk,mid,r.P,r.model)>yc?hi=mid:lo=mid}
    const xv=(lo+hi)/2;
    steps.push({x1:xc,y1:yc,x2:xv,y2:yc}); // horizontal to VLE
    stages++;
    if(xv<=r.xW+1e-4){reachedBottom=true;break}
    // Vertical step: choose optimal operating line
    let yop;
    const yEnr=sl*xv+ic;
    const yStr=r.xW+slStr*(xv-r.xW);
    if(usedStripping){
      yop=yStr;
    } else if(xv<=r.xF){
      yop=yStr;
      usedStripping=true;
    } else {
      // Optimal feed stage: switch to stripping if it gives a wider step
      if(yStr<yEnr && yStr<yc && yStr>=r.xW){
        yop=yStr;usedStripping=true;
      } else {
        yop=yEnr;
      }
    }
    yop=Math.max(yop,r.xW);
    // Pinch detection: the vertical gap (yc - yop) is the driving force for
    // this stage. When it becomes negligible, we're in a pinch zone ‚Äî the
    // operating line is practically touching the VLE curve.
    const stepHeight=yc-yop;
    if(stepHeight<pinchThreshold && i>3){
      pinchBreak=true;break;
    }
    steps.push({x1:xv,y1:yc,x2:xv,y2:yop}); // vertical to op line
    xc=xv;yc=yop;
    if(xv<=r.xW+1e-4){reachedBottom=true;break}
  }
  mcData={r,sl,ic,yqPt,vlePts,steps,stages};
  mcCenter={x:0.5,y:0.5};
  document.getElementById('mcZoomSlider').value=1;
  document.getElementById('mcZoomLbl').textContent='1√ó';
  mcRender(0,0,1,1); // full view
  let mcWarn='',mcMethod='';
  // Single Nth: McCabe when completed, Gilliland as fallback
  if(reachedBottom && stages>0){
    r.Nth=stages;
    r.Nact=Math.ceil(stages/r.eta);
    r.Hpack=stages*r.hetp;
    r.Htot=r.Hpack+1.5+1.0;
    r.dPtot=({structured:.3,random:.5,sieve:.7,valve:.6}[r.intType]||.5)*r.Hpack;
    mcMethod='McCabe-Thiele';
    showResults();
  } else {
    mcMethod='Gilliland';
  }
  if(pinchBreak){
    const azeoNote=r.azeos.length>0?' L\'az√©otrope √† x='+r.azeos[0].x.toFixed(3)+' limite la s√©paration.':'';
    mcWarn='<div style="color:#f59e0b;font-size:.78rem;margin-top:.3rem">‚ö†Ô∏è Pinch d√©tect√©e √† '+stages+' √©tages ‚Äî l\'escalier ne peut atteindre xW.'+azeoNote+' Dimensionnement bas√© sur Gilliland ('+Math.ceil(r.Nth)+' plateaux).</div>';
  }
  if(stages>=maxStages){
    mcWarn='<div style="color:#ef4444;font-size:.78rem;margin-top:.3rem">‚ö†Ô∏è >200 √©tages ‚Äî s√©paration impossible avec ces sp√©cifications. Augmenter le reflux.</div>';
  }
  document.getElementById('mcRes').innerHTML=rc(Math.ceil(r.Nth),'N th√©oriques ('+mcMethod+')','')+rc(stages,'√âtages McCabe','')+rc(r.R.toFixed(2),'Reflux R','')+rc(r.Rmin.toFixed(2),'Rmin','')+mcWarn;
  if(!mcListenersAttached) setupMcInteraction();
}

let mcView={x0:0,y0:0,x1:1,y1:1}; // current view bounds

function mcRender(vx0,vy0,vx1,vy1){
  if(!mcData)return;
  mcView={x0:vx0,y0:vy0,x1:vx1,y1:vy1};
  const{r,sl,ic,yqPt,vlePts,steps,stages}=mcData;
  const W=800,H=800,m=55,pW=W-2*m,pH=H-2*m;
  const sx=v=>(v-vx0)/(vx1-vx0),sy=v=>(v-vy0)/(vy1-vy0);
  const tx=v=>m+sx(v)*pW,ty=v=>H-m-sy(v)*pH;

  // Grid lines
  const step=vx1-vx0>0.5?0.1:vx1-vx0>0.2?0.05:vx1-vx0>0.1?0.02:0.01;
  let gridSvg='';
  for(let v=Math.ceil(vx0/step)*step;v<=vx1;v+=step){
    const px=tx(v);
    gridSvg+='<line x1="'+px+'" y1="'+ty(vy0)+'" x2="'+px+'" y2="'+ty(vy1)+'" stroke="#e5e7eb" stroke-width="0.5"/>';
    gridSvg+='<text x="'+px+'" y="'+(H-m+16)+'" text-anchor="middle" font-size="10" fill="#666" font-family="Space Mono">'+v.toFixed(step<0.05?3:2)+'</text>';
  }
  for(let v=Math.ceil(vy0/step)*step;v<=vy1;v+=step){
    const py=ty(v);
    gridSvg+='<line x1="'+tx(vx0)+'" y1="'+py+'" x2="'+tx(vx1)+'" y2="'+py+'" stroke="#e5e7eb" stroke-width="0.5"/>';
    gridSvg+='<text x="'+(m-5)+'" y="'+(py+4)+'" text-anchor="end" font-size="10" fill="#666" font-family="Space Mono">'+v.toFixed(step<0.05?3:2)+'</text>';
  }

  // Diagonal y=x
  const diagSvg='<line x1="'+tx(Math.max(vx0,vy0))+'" y1="'+ty(Math.max(vx0,vy0))+'" x2="'+tx(Math.min(vx1,vy1))+'" y2="'+ty(Math.min(vx1,vy1))+'" stroke="#aaa" stroke-width="1" stroke-dasharray="6,4"/>';

  // VLE curve
  let vlePath='';
  vlePts.filter(p=>p.x>=vx0-.05&&p.x<=vx1+.05).forEach((p,i)=>{vlePath+=(i===0?'M':'L')+tx(p.x).toFixed(1)+','+ty(p.y).toFixed(1)});
  const vleSvg='<path d="'+vlePath+'" fill="none" stroke="#2563eb" stroke-width="2.5"/>';

  // Enriching line (from feed to distillate only)
  const enrSvg='<line x1="'+tx(r.xF)+'" y1="'+ty(yqPt)+'" x2="'+tx(r.xD)+'" y2="'+ty(r.xD)+'" stroke="#059669" stroke-width="2"/>';
  // Stripping line (from bottoms to feed)
  const strSvg='<line x1="'+tx(r.xW)+'" y1="'+ty(r.xW)+'" x2="'+tx(r.xF)+'" y2="'+ty(yqPt)+'" stroke="#7c3aed" stroke-width="2"/>';
  // q-line
  const qSvg='<line x1="'+tx(r.xF)+'" y1="'+ty(Math.max(vy0,0))+'" x2="'+tx(r.xF)+'" y2="'+ty(Math.min(vy1,1))+'" stroke="#9ca3af" stroke-width="1" stroke-dasharray="4,4"/>';

  // McCabe steps
  let stepsSvg='';let stNum=0;
  for(let i=0;i<steps.length;i++){
    const s=steps[i];
    stepsSvg+='<line x1="'+tx(s.x1).toFixed(1)+'" y1="'+ty(s.y1).toFixed(1)+'" x2="'+tx(s.x2).toFixed(1)+'" y2="'+ty(s.y2).toFixed(1)+'" stroke="#f59e0b" stroke-width="1.5"/>';
    // Number on horizontal segments (each = 1 theoretical stage)
    if(i%2===0){
      stNum++;
      const mx=(s.x1+s.x2)/2,my=s.y1;
      if(mx>=vx0&&mx<=vx1&&my>=vy0&&my<=vy1){
        const fs=Math.max(7,Math.min(11,10/(vx1-vx0)));
        stepsSvg+='<text x="'+(tx(mx)+8)+'" y="'+(ty(my)-4)+'" font-size="'+fs+'" fill="#92400e" font-weight="bold" font-family="Space Mono">'+stNum+'</text>';
      }
    }
  }

  // Markers xF, xD, xW
  let markSvg='';
  [{l:'xW',v:r.xW},{l:'xF',v:r.xF},{l:'xD',v:r.xD}].forEach(({l,v})=>{
    if(v>=vx0&&v<=vx1){
      markSvg+='<circle cx="'+tx(v)+'" cy="'+ty(vy0)+'" r="4" fill="#dc2626"/>';
      markSvg+='<text x="'+tx(v)+'" y="'+(H-m+32)+'" text-anchor="middle" font-size="11" fill="#dc2626" font-weight="bold" font-family="Space Mono">'+l+'='+v+'</text>';
    }
  });

  // Title
  const titleSvg='<text x="'+W/2+'" y="22" text-anchor="middle" font-size="14" font-weight="bold" fill="#111" font-family="DM Sans">McCabe-Thiele ‚Äî '+r.l.n+' / '+r.h.n+' ('+r.model.toUpperCase()+') ‚Äî '+stages+' √©tages</text>';

  // Axis labels
  const axSvg='<text x="'+W/2+'" y="'+(H-5)+'" text-anchor="middle" font-size="12" fill="#666" font-family="DM Sans">x (liquide)</text>'+
    '<text x="12" y="'+H/2+'" text-anchor="middle" font-size="12" fill="#666" font-family="DM Sans" transform="rotate(-90,12,'+H/2+')">y (vapeur)</text>';

  // Legend
  const lx=m+10,ly2=m+10;
  const legSvg='<rect x="'+lx+'" y="'+ly2+'" width="230" height="125" fill="white" fill-opacity=".92" stroke="#ddd" rx="5"/>'+
    [['#2563eb',2.5,'VLE ('+r.model.toUpperCase()+')'],['#059669',2,'Enrichissement'],['#7c3aed',2,'Appauvrissement'],['#aaa',1,'Diagonale y=x'],['#f59e0b',1.5,stages+' √©tages']].map(([c,w,t],i)=>
      '<line x1="'+(lx+10)+'" y1="'+(ly2+20+i*21)+'" x2="'+(lx+40)+'" y2="'+(ly2+20+i*21)+'" stroke="'+c+'" stroke-width="'+w+'"/>'+
      '<text x="'+(lx+48)+'" y="'+(ly2+24+i*21)+'" font-size="11" fill="#333" font-family="DM Sans">'+t+'</text>'
    ).join('');

  // Clip area
  const clip='<defs><clipPath id="plotArea"><rect x="'+m+'" y="'+m+'" width="'+pW+'" height="'+pH+'"/></clipPath></defs>';
  
  document.getElementById('mcSvg').innerHTML=clip+'<rect width="'+W+'" height="'+H+'" fill="white"/>'+
    '<g clip-path="url(#plotArea)">'+gridSvg+diagSvg+vleSvg+enrSvg+strSvg+qSvg+stepsSvg+markSvg+'</g>'+
    '<rect x="'+m+'" y="'+m+'" width="'+pW+'" height="'+pH+'" fill="none" stroke="#ccc"/>'+
    axSvg+titleSvg+legSvg;
}

// Center of current view (for zoom slider)
let mcCenter={x:0.5,y:0.5};

function mcSliderZoom(){
  if(!mcData)return;
  const z=+document.getElementById('mcZoomSlider').value;
  document.getElementById('mcZoomLbl').textContent=z.toFixed(z>=2?0:1)+'√ó';
  const half=0.5/z;
  // Clamp center so view stays in [0,1]
  const cx=Math.max(half,Math.min(1-half,mcCenter.x));
  const cy=Math.max(half,Math.min(1-half,mcCenter.y));
  mcCenter.x=cx;mcCenter.y=cy;
  mcRender(cx-half,cy-half,cx+half,cy+half);
}

function mcZoom(mode){
  if(!mcData)return;const r=mcData.r;
  if(mode==='full'){
    mcCenter={x:.5,y:.5};document.getElementById('mcZoomSlider').value=1;
    document.getElementById('mcZoomLbl').textContent='1√ó';
    mcRender(0,0,1,1);return;
  }
  // Calculate target center and zoom
  let tx=.5,ty=.5,tz=5;
  if(mode==='steps'){
    let xMin=1,xMax=0,yMin=1,yMax=0;
    mcData.steps.forEach(s=>{xMin=Math.min(xMin,s.x1,s.x2);xMax=Math.max(xMax,s.x1,s.x2);yMin=Math.min(yMin,s.y1,s.y2);yMax=Math.max(yMax,s.y1,s.y2)});
    tx=(xMin+xMax)/2;ty=(yMin+yMax)/2;
    const span=Math.max(xMax-xMin,yMax-yMin)+.08;
    tz=Math.min(20,Math.max(1,1/span));
  }
  else if(mode==='top'){tx=r.xD;ty=r.xD;tz=6;}
  else if(mode==='bot'){tx=r.xW+.05;ty=r.xW+.05;tz=6;}
  else if(mode==='feed'){tx=r.xF;ty=r.xF;tz=4;}
  mcCenter={x:tx,y:ty};
  document.getElementById('mcZoomSlider').value=Math.min(20,tz);
  document.getElementById('mcZoomLbl').textContent=tz.toFixed(tz>=2?0:1)+'√ó';
  const half=0.5/tz;
  const cx=Math.max(half,Math.min(1-half,tx)),cy=Math.max(half,Math.min(1-half,ty));
  mcRender(cx-half,cy-half,cx+half,cy+half);
}

let mcListenersAttached=false;
function setupMcInteraction(){
  mcListenersAttached=true;
  const container=document.getElementById('mcbContainer');
  let dragging=false,startX,startY;

  container.addEventListener('mousedown',e=>{dragging=true;startX=e.clientX;startY=e.clientY;container.style.cursor='grabbing';e.preventDefault()});
  window.addEventListener('mousemove',e=>{
    if(!dragging)return;
    const rect=container.getBoundingClientRect();
    const dx=-(e.clientX-startX)/rect.width*(mcView.x1-mcView.x0);
    const dy=(e.clientY-startY)/rect.height*(mcView.y1-mcView.y0);
    startX=e.clientX;startY=e.clientY;
    const w=mcView.x1-mcView.x0,h=mcView.y1-mcView.y0;
    let nx0=Math.max(0,Math.min(mcView.x0+dx,1-w));
    let ny0=Math.max(0,Math.min(mcView.y0+dy,1-h));
    mcCenter.x=nx0+w/2;mcCenter.y=ny0+h/2;
    mcRender(nx0,ny0,nx0+w,ny0+h);
  });
  window.addEventListener('mouseup',()=>{dragging=false;container.style.cursor='grab'});

  // Mouse wheel ‚Üí update slider (scroll up = zoom in)
  container.addEventListener('wheel',e=>{
    e.preventDefault();e.stopPropagation();
    const sl=document.getElementById('mcZoomSlider');
    const cur=+sl.value;
    const step=cur<5?0.5:1;
    sl.value=Math.max(1,Math.min(20,cur+(e.deltaY<0?step:-step)));
    // Update center to cursor position on zoom in
    if(e.deltaY<0){
      const rect=container.getBoundingClientRect();
      const fx=(e.clientX-rect.left)/rect.width;
      const fy=1-(e.clientY-rect.top)/rect.height;
      const px=mcView.x0+fx*(mcView.x1-mcView.x0);
      const py=mcView.y0+fy*(mcView.y1-mcView.y0);
      // Blend center toward cursor
      mcCenter.x=mcCenter.x*0.6+px*0.4;
      mcCenter.y=mcCenter.y*0.6+py*0.4;
    }
    mcSliderZoom();
  },{passive:false});

  // Touch: drag to pan, pinch to zoom
  let lastTouchDist=0;
  container.addEventListener('touchstart',e=>{
    if(e.touches.length===1){dragging=true;startX=e.touches[0].clientX;startY=e.touches[0].clientY}
    if(e.touches.length===2){const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;lastTouchDist=Math.sqrt(dx*dx+dy*dy)}
  },{passive:true});
  container.addEventListener('touchmove',e=>{
    e.preventDefault();
    if(e.touches.length===1&&dragging){
      const rect=container.getBoundingClientRect();
      const dx=-(e.touches[0].clientX-startX)/rect.width*(mcView.x1-mcView.x0);
      const dy=(e.touches[0].clientY-startY)/rect.height*(mcView.y1-mcView.y0);
      startX=e.touches[0].clientX;startY=e.touches[0].clientY;
      const w=mcView.x1-mcView.x0,h=mcView.y1-mcView.y0;
      let nx0=Math.max(0,Math.min(mcView.x0+dx,1-w)),ny0=Math.max(0,Math.min(mcView.y0+dy,1-h));
      mcCenter.x=nx0+w/2;mcCenter.y=ny0+h/2;
      mcRender(nx0,ny0,nx0+w,ny0+h);
    }
    if(e.touches.length===2){
      const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;
      const dist=Math.sqrt(dx*dx+dy*dy);
      const sl=document.getElementById('mcZoomSlider');
      sl.value=Math.max(1,Math.min(20,+sl.value*(dist/lastTouchDist)));
      lastTouchDist=dist;
      mcSliderZoom();
    }
  },{passive:false});
  container.addEventListener('touchend',()=>{dragging=false});
}

function dlMcCabe(){const svg=document.getElementById('mcSvg'),b=new Blob(['<?xml version="1.0"?>\n'+svg.outerHTML],{type:'image/svg+xml'}),a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='McCabe_Thiele.svg';a.click()}


// ===== ANIMATION =====
let animSpd=1;
function setSpd(v){animSpd=v;document.getElementById('aSpdCustom').value='';document.querySelectorAll('.aspd').forEach(b=>b.classList.remove('active'));event.target.classList.add('active')}
function setSpdCustom(){const v=+document.getElementById('aSpdCustom').value;if(v>0){animSpd=v;document.querySelectorAll('.aspd').forEach(b=>b.classList.remove('active'))}}
function resetAnim(){playing=false;cancelAnimationFrame(animId);document.getElementById('btnPP').textContent='‚ñ∂ D√©marrer';document.getElementById('tSlider').value=0;drawAnim(0)}

function drawAnim(pct){
  if(!R_){document.getElementById('aSvg').innerHTML='<text x="600" y="390" text-anchor="middle" font-family="Arial,sans-serif" font-size="16" fill="#888">Lancez un calcul pour afficher l\u2019animation PFD</text>';return;}
  const r=R_,idx=Math.min(Math.round(pct/100*(r.sim.length-1)),r.sim.length-1),d=r.sim[idx];
  document.getElementById('tDisp').textContent='t = '+d.t.toFixed(0)+' min';
  const svg=document.getElementById('aSvg'),prog=pct/100,lvl=Math.max(.05,1-prog);
  const BK='#263238',GR='#546e7a',LG='#90a4ae',WH='#fff';
  const Tmin=r.l.tb||60,Tmax=r.h.tb||100;
  const Tfrac=Math.max(0,Math.min(1,(d.Tb-Tmin)/(Tmax-Tmin+20)));
  // Dynamic liquid color: cool blue ‚Üí warm orange ‚Üí hot red
  const lR=Math.round(25+200*Tfrac),lG=Math.round(118-60*Tfrac),lB=Math.round(210-180*Tfrac);
  const liqClr='rgb('+lR+','+lG+','+lB+')';
  const liqDk='rgb('+Math.round(lR*.7)+','+Math.round(lG*.7)+','+Math.round(lB*.7)+')';
  const vapClr='#7c4dff',vapLt='#b388ff',stmClr='#e53935',cwClr='#00897b',dstClr='#2e7d32',rfxClr='#e65100',resClr='#6d4c41';
  // Helpers
  function tx(x,y,str,sz,o){o=o||{};return'<text x="'+x+'" y="'+y+'" font-family="Inter,Arial,sans-serif" font-size="'+sz+'" fill="'+(o.c||BK)+'" text-anchor="'+(o.a||'middle')+'"'+(o.b?' font-weight="600"':'')+(o.o?' opacity="'+o.o+'"':'')+'>'+str+'</text>';}
  function ln(x1,y1,x2,y2,c,w,o){return'<line x1="'+x1+'" y1="'+y1+'" x2="'+x2+'" y2="'+y2+'" stroke="'+c+'" stroke-width="'+w+'"'+(o?' '+o:'')+'/>';}
  function pl(pts,c,w,o){return'<polyline points="'+pts+'" fill="none" stroke="'+c+'" stroke-width="'+w+'" stroke-linejoin="round" stroke-linecap="round"'+(o?' '+o:'')+'/>';}
  function aFlow(pts,c,w,dur,rev){var v=rev?'0;20':'0;-20';return'<polyline points="'+pts+'" fill="none" stroke="'+c+'" stroke-width="'+w+'" stroke-dasharray="14,7" stroke-linecap="round" stroke-linejoin="round" opacity=".85"><animate attributeName="stroke-dashoffset" dur="'+dur+'s" repeatCount="indefinite" values="'+v+'"/></polyline>';}
  function pill(x,y,w,h,c,sw){return'<rect x="'+x+'" y="'+y+'" width="'+w+'" height="'+h+'" rx="'+(h/2)+'" fill="'+WH+'" stroke="'+(c||BK)+'" stroke-width="'+(sw||1.5)+'"/>';}
  // Equipment tag (badge ISA style)
  function eqBadge(x,y,tag,desc){var tw=Math.max(tag.length*7.5,desc.length*6)+16;return'<rect x="'+(x-tw/2)+'" y="'+y+'" width="'+tw+'" height="32" rx="4" fill="'+WH+'" stroke="'+BK+'" stroke-width="1.5" filter="url(#sh)"/>'+ln(x-tw/2,y+16,x+tw/2,y+16,LG,.6)+tx(x,y+12,tag,9.5,{b:true})+tx(x,y+26,desc,7,{c:GR});}
  // Metric box (inline digital display style)
  function mBox(x,y,label,val,unit,c){return'<rect x="'+x+'" y="'+y+'" width="88" height="40" rx="5" fill="'+WH+'" stroke="'+(c||'#78909c')+'" stroke-width="1.2" filter="url(#sh)"/>'+tx(x+44,y+14,label,7,{c:GR})+tx(x+44,y+32,val+(unit||''),11,{c:c||BK,b:true});}
  // Stream number bubble
  function sNum(x,y,n,c){return'<circle cx="'+x+'" cy="'+y+'" r="10" fill="'+WH+'" stroke="'+(c||BK)+'" stroke-width="1.4"/>'+tx(x,y+4,n,9,{b:true,c:c||BK});}
  // 3D vessel shadow helper
  function vShadow(x,y,w,h){return'<rect x="'+(x+3)+'" y="'+(y+3)+'" width="'+w+'" height="'+h+'" rx="6" fill="#000" opacity=".08"/>';}

  // ========= DEFS (gradients, filters, markers) =========
  var s='<defs>'+
  '<filter id="sh" x="-4%" y="-4%" width="110%" height="115%"><feDropShadow dx="1.5" dy="1.5" stdDeviation="2" flood-opacity=".12"/></filter>'+
  '<filter id="glow"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>'+
  '<linearGradient id="gMetal" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="#e0e0e0"/><stop offset="30%" stop-color="#f5f5f5"/><stop offset="70%" stop-color="#fafafa"/><stop offset="100%" stop-color="#e0e0e0"/></linearGradient>'+
  '<linearGradient id="gMetalV" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#e0e0e0"/><stop offset="30%" stop-color="#f5f5f5"/><stop offset="70%" stop-color="#fafafa"/><stop offset="100%" stop-color="#e0e0e0"/></linearGradient>'+
  '<linearGradient id="gLiq" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="'+liqClr+'" stop-opacity=".25"/><stop offset="100%" stop-color="'+liqClr+'" stop-opacity=".65"/></linearGradient>'+
  '<linearGradient id="gDst" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="'+dstClr+'" stop-opacity=".15"/><stop offset="100%" stop-color="'+dstClr+'" stop-opacity=".5"/></linearGradient>'+
  '<linearGradient id="gCol" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="#cfd8dc"/><stop offset="15%" stop-color="#eceff1"/><stop offset="50%" stop-color="#fafafa"/><stop offset="85%" stop-color="#eceff1"/><stop offset="100%" stop-color="#cfd8dc"/></linearGradient>'+
  '<linearGradient id="gVap" x1="0" y1="1" x2="0" y2="0"><stop offset="0%" stop-color="'+vapClr+'" stop-opacity=".08"/><stop offset="100%" stop-color="'+vapClr+'" stop-opacity=".25"/></linearGradient>'+
  '<radialGradient id="gHX" cx=".35" cy=".35"><stop offset="0%" stop-color="#fafafa"/><stop offset="100%" stop-color="#cfd8dc"/></radialGradient>'+
  '<marker id="aw" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto" markerUnits="userSpaceOnUse"><polygon points="0 0,8 3,0 6" fill="'+BK+'"/></marker>'+
  '</defs>';

  // ========= BACKGROUND =========
  s+='<rect width="1200" height="780" fill="#f8f9fa" rx="3"/>';

  // ========= LAYOUT =========
  var CX=195,CY=50,CW=80,CH=350; // Column
  var BX=80,BY=470,BW=240,BH=180;// Reboiler (kettle)
  var EX=560,EY=35;                // Condenser center
  var DX=540,DY=170,DW=130,DH=48; // Reflux drum
  var TX=860,TY=100,TW=120,TH=160;// Distillate tank
  var RX=430,RY=610,RW=100,RH=80; // Residue tank
  var nP=Math.min(r.Nact||8,14),trSp=(CH-40)/nP;
  var feedY=CY+CH*.55;
  var teeX=DX+DW+45,teeY=DY+DH/2;
  var rfxY=CY+35;

  // ========= PROCESS FLOW LINES (behind everything) =========
  // Feed line (blue)
  s+=aFlow('60,'+feedY+' '+CX+','+feedY,'#1976d2',2.5,2);
  // Column bottom ‚Üí reboiler (vapor return)
  s+=aFlow((CX+CW/2)+','+(CY+CH+8)+' '+(BX+BW/2)+','+BY,vapClr,2,1.2);
  // Reboiler vapor ‚Üí column bottom
  s+=aFlow((BX+BW/2)+','+BY+' '+(CX+CW/2)+','+(CY+CH),vapClr,2,1.2,true);
  // Vapor overhead: column top ‚Üí condenser
  s+=aFlow((CX+CW)+','+(CY+20)+' '+(CX+CW+40)+','+(CY+20)+' '+(CX+CW+40)+','+(EY+25)+' '+(EX-55)+','+(EY+25),vapClr,2.5,1.5);
  // Condensate: condenser ‚Üí drum
  s+=aFlow(EX+','+(EY+50)+' '+EX+','+(DY)+' '+(DX+DW/2)+','+DY,BK,2,1.8);
  // Drum ‚Üí tee
  s+=pl((DX+DW)+','+teeY+' '+teeX+','+teeY,BK,2.5);
  s+='<circle cx="'+teeX+'" cy="'+teeY+'" r="3.5" fill="'+BK+'"/>';
  // Reflux: tee ‚Üí column top
  s+=aFlow(teeX+','+teeY+' '+teeX+','+rfxY+' '+(CX+CW+1)+','+rfxY,rfxClr,2,2,true);
  // Distillate: tee ‚Üí tank
  s+=aFlow(teeX+','+teeY+' '+(TX+TW/2)+','+teeY+' '+(TX+TW/2)+','+(TY+5),dstClr,2,2.5);
  // Residue: reboiler ‚Üí tank
  s+=aFlow((BX+BW)+','+(BY+BH/2)+' '+(BX+BW+40)+','+(BY+BH/2)+' '+(BX+BW+40)+','+(RY+RH/2)+' '+RX+','+(RY+RH/2),resClr,1.5,3);
  // Steam in (dashed utility)
  s+='<line x1="'+(BX-10)+'" y1="'+(BY+BH-35)+'" x2="'+BX+'" y2="'+(BY+BH-35)+'" stroke="'+stmClr+'" stroke-width="1.8" stroke-dasharray="6,3"/>';
  // Condensate out
  s+='<line x1="'+(BX+BW)+'" y1="'+(BY+BH-35)+'" x2="'+(BX+BW+25)+'" y2="'+(BY+BH-35)+'" stroke="'+LG+'" stroke-width="1.5" stroke-dasharray="6,3"/>';
  // CW lines
  s+='<line x1="'+(EX+55)+'" y1="'+(EY+12)+'" x2="'+(EX+82)+'" y2="'+(EY+12)+'" stroke="'+cwClr+'" stroke-width="1.5" stroke-dasharray="6,3"/>';
  s+='<line x1="'+(EX+55)+'" y1="'+(EY+38)+'" x2="'+(EX+82)+'" y2="'+(EY+38)+'" stroke="'+cwClr+'" stroke-width="1.5" stroke-dasharray="6,3"/>';

  // ========= COLUMN C-101 (3D metallic look) =========
  s+=vShadow(CX,CY,CW,CH);
  s+='<rect x="'+CX+'" y="'+CY+'" width="'+CW+'" height="'+CH+'" rx="6" fill="url(#gCol)" stroke="'+BK+'" stroke-width="2" filter="url(#sh)"/>';
  // Top & bottom dished heads
  s+='<path d="M'+CX+','+(CY+6)+' Q'+(CX+CW/2)+','+(CY-10)+' '+(CX+CW)+','+(CY+6)+'" fill="none" stroke="'+BK+'" stroke-width="2"/>';
  s+='<path d="M'+CX+','+(CY+CH-6)+' Q'+(CX+CW/2)+','+(CY+CH+10)+' '+(CX+CW)+','+(CY+CH-6)+'" fill="none" stroke="'+BK+'" stroke-width="2"/>';
  // Vapor space gradient at top
  s+='<rect x="'+(CX+3)+'" y="'+(CY+8)+'" width="'+(CW-6)+'" height="'+(CH*.15)+'" rx="3" fill="url(#gVap)" opacity=".6"/>';
  // Trays with liquid holdup
  for(var j=0;j<nP;j++){
    var py=CY+25+j*trSp;
    s+=ln(CX+5,py,CX+CW-5,py,'#b0bec5',1);
    s+=ln(CX+CW-15,py,CX+CW-15,py-trSp*.3,'#b0bec5',.7);
    if(prog<.97){
      var holdup=Math.max(0.08,(1-j/nP)*.45);
      s+='<rect x="'+(CX+6)+'" y="'+(py-3)+'" width="'+((CW-12)*holdup)+'" height="3" rx="1.5" fill="'+liqClr+'" opacity=".35"/>';
    }
  }
  // Column highlight stripe (3D effect)
  s+='<rect x="'+(CX+CW*.65)+'" y="'+(CY+10)+'" width="4" height="'+(CH-20)+'" rx="2" fill="'+WH+'" opacity=".25"/>';
  s+=eqBadge(CX+CW/2,CY-44,'C-101',nP+' plateaux');
  s+=tx(CX+CW/2,CY-56,'DN'+((r.Dstd||.1)*1000).toFixed(0)+' ¬∑ H='+(r.Htot||1).toFixed(1)+'m',7.5,{c:LG});
  // Feed nozzle
  s+='<rect x="'+(CX-8)+'" y="'+(feedY-5)+'" width="10" height="10" rx="2" fill="url(#gMetal)" stroke="'+BK+'" stroke-width="1.2"/>';
  s+=tx(CX-16,feedY-10,'Charge',7.5,{c:'#1976d2',a:'end'});

  // ========= REBOILER E-101 (kettle style) =========
  s+=vShadow(BX,BY,BW,BH);
  s+='<rect x="'+BX+'" y="'+BY+'" width="'+BW+'" height="'+BH+'" rx="12" fill="url(#gMetal)" stroke="'+BK+'" stroke-width="2" filter="url(#sh)"/>';
  // Liquid fill
  var liqH=BH*lvl,liqY=BY+BH-liqH;
  s+='<rect x="'+(BX+3)+'" y="'+liqY+'" width="'+(BW-6)+'" height="'+Math.max(0,liqH-14)+'" rx="9" fill="url(#gLiq)"/>';
  // Wave surface
  if(prog<.97){
    var wv='M'+(BX+4)+','+liqY;
    for(var wx=0;wx<=BW-8;wx+=4){wv+=' L'+(BX+4+wx)+','+(liqY+Math.sin(wx*.04+Date.now()/500)*2.5);}
    wv+=' L'+(BX+BW-4)+','+(liqY+6)+' L'+(BX+4)+','+(liqY+6)+' Z';
    s+='<path d="'+wv+'" fill="'+liqClr+'" opacity=".2"/>';
    // Bubbles
    for(var i=0;i<6;i++){
      var bx2=BX+25+Math.random()*(BW-50),br=(1.5+Math.random()*2.5).toFixed(1),bd=(1.2+Math.random()*2).toFixed(1);
      s+='<circle cx="'+bx2+'" cy="'+(BY+BH-15)+'" r="'+br+'" fill="'+WH+'" opacity=".4" stroke="'+liqClr+'" stroke-width=".5"><animate attributeName="cy" dur="'+bd+'s" repeatCount="indefinite" values="'+(BY+BH-15)+';'+(liqY+8)+';'+(BY+BH-15)+'"/><animate attributeName="opacity" dur="'+bd+'s" repeatCount="indefinite" values=".5;0;.5"/></circle>';
    }
  }
  // Tube bundle hint (horizontal lines inside)
  for(var ti=0;ti<4;ti++){
    var ty2=BY+BH-25-ti*18;
    s+=ln(BX+20,ty2,BX+BW-20,ty2,'#b0bec5',.5,'opacity=".4"');
  }
  // 3D highlight
  s+='<rect x="'+(BX+BW*.7)+'" y="'+(BY+12)+'" width="5" height="'+(BH-24)+'" rx="2.5" fill="'+WH+'" opacity=".2"/>';
  s+=eqBadge(BX+BW/2,BY-40,'E-101','Bouilleur');
  // Composition readout
  s+=tx(BX+BW/2,liqY>BY+35?BY+30:liqY+20,'x = '+d.xs.toFixed(4),13,{b:true,c:liqDk});
  // Duty & temperature
  s+=mBox(BX-95,BY+BH/2-20,'\u0422 bouilleur',d.Tb.toFixed(1),'¬∞C',liqDk);
  s+=mBox(BX+BW/2-44,BY+BH+10,'Q reboiler',d.Qr.toFixed(1),' kW',stmClr);
  // Utility labels
  s+=tx(BX-15,BY+BH-30,'Vap. '+(r.stT||120)+'¬∞C',7,{c:stmClr,a:'end'});
  s+=tx(BX+BW+30,BY+BH-30,'Cond.',7,{c:LG,a:'start'});

  // ========= CONDENSER E-102 (shell & tube, horizontal) =========
  s+='<ellipse cx="'+EX+'" cy="'+(EY+25)+'" rx="52" ry="25" fill="url(#gHX)" stroke="'+BK+'" stroke-width="2" filter="url(#sh)"/>';
  s+=ln(EX-14,EY+3,EX-14,EY+47,LG,.8)+ln(EX+14,EY+3,EX+14,EY+47,LG,.8);
  // 3D highlight
  s+='<ellipse cx="'+(EX-15)+'" cy="'+(EY+15)+'" rx="18" ry="8" fill="'+WH+'" opacity=".3"/>';
  s+=eqBadge(EX,EY-22,'E-102','Condenseur');
  s+=mBox(EX+85,EY+5,'Q condenseur',d.Qc.toFixed(1),' kW',cwClr);
  s+=tx(EX+87,EY+10,'CW in',7,{c:cwClr,a:'start'});
  s+=tx(EX+87,EY+42,'CW out',7,{c:cwClr,a:'start'});
  s+=mBox(EX+85,EY+52,'T distillat',d.Tt.toFixed(1),'¬∞C','#1976d2');

  // ========= REFLUX DRUM D-101 =========
  var dr2=DH/2;
  s+='<path d="M'+(DX+dr2)+','+DY+' L'+(DX+DW-dr2)+','+DY+' Q'+(DX+DW)+','+DY+' '+(DX+DW)+','+(DY+dr2)+' Q'+(DX+DW)+','+(DY+DH)+' '+(DX+DW-dr2)+','+(DY+DH)+' L'+(DX+dr2)+','+(DY+DH)+' Q'+DX+','+(DY+DH)+' '+DX+','+(DY+dr2)+' Q'+DX+','+DY+' '+(DX+dr2)+','+DY+' Z" fill="url(#gMetalV)" stroke="'+BK+'" stroke-width="2" filter="url(#sh)"/>';
  // Liquid level in drum
  s+='<rect x="'+(DX+5)+'" y="'+(DY+DH*.35)+'" width="'+(DW-10)+'" height="'+(DH*.6)+'" rx="3" fill="'+dstClr+'" opacity=".12"/>';
  s+=eqBadge(DX+DW/2,DY-36,'D-101','Ballon reflux');

  // ========= REFLUX DISPLAY =========
  s+='<rect x="'+(teeX+8)+'" y="'+(rfxY+5)+'" width="84" height="26" rx="5" fill="#fff3e0" stroke="'+rfxClr+'" stroke-width="1.2" filter="url(#sh)"/>';
  s+=tx(teeX+50,rfxY+22,'R = '+d.Ra.toFixed(2),10.5,{c:rfxClr,b:true});

  // ========= DISTILLATE TANK T-102 =========
  s+=vShadow(TX,TY,TW,TH);
  s+='<path d="M'+TX+','+(TY+TH)+' L'+TX+','+(TY+16)+' Q'+TX+','+TY+' '+(TX+TW/2)+','+TY+' Q'+(TX+TW)+','+TY+' '+(TX+TW)+','+(TY+16)+' L'+(TX+TW)+','+(TY+TH)+' Z" fill="url(#gMetal)" stroke="'+BK+'" stroke-width="2" filter="url(#sh)"/>';
  var dLvl=Math.min(prog,.95),dLH2=TH*dLvl*.85;
  s+='<rect x="'+(TX+3)+'" y="'+(TY+TH-dLH2)+'" width="'+(TW-6)+'" height="'+dLH2+'" rx="2" fill="url(#gDst)"/>';
  // Roof highlight
  s+='<path d="M'+(TX+8)+','+(TY+12)+' Q'+(TX+TW/2)+','+(TY+4)+' '+(TX+TW-8)+','+(TY+12)+'" fill="'+WH+'" opacity=".35"/>';
  s+=eqBadge(TX+TW/2,TY-38,'T-102','Bac distillat');
  s+=tx(TX+TW/2,TY+TH-10,d.Dv.toFixed(1)+' L',13,{c:dstClr,b:true});
  s+=mBox(TX+TW+12,TY+50,'xD distillat',d.xDi.toFixed(3),'',dstClr);

  // ========= RESIDUE TANK T-103 =========
  s+='<rect x="'+RX+'" y="'+RY+'" width="'+RW+'" height="'+RH+'" rx="6" fill="url(#gMetal)" stroke="'+BK+'" stroke-width="1.8" filter="url(#sh)"/>';
  s+=eqBadge(RX+RW/2,RY-34,'T-103','R√©sidu');

  // ========= STREAM NUMBERS =========
  s+=sNum(CX-30,feedY,'1','#1976d2');
  s+=sNum(CX+CW+20,CY+20,'2',vapClr);
  s+=sNum((teeX+TX+TW/2)/2,teeY-14,'3',dstClr);
  s+=sNum(teeX+5,rfxY-8,'4',rfxClr);
  s+=sNum(BX+BW+20,BY+BH/2-14,'5',resClr);

  // ========= PROGRESS BAR =========
  var pcClr=prog<.85?'#43a047':prog<.95?'#ef6c00':'#c62828';
  var pbX=30,pbY=700,pbW=320;
  s+='<rect x="'+pbX+'" y="'+pbY+'" width="'+pbW+'" height="10" rx="5" fill="#e0e0e0"/>';
  s+='<rect x="'+pbX+'" y="'+pbY+'" width="'+(pbW*prog)+'" height="10" rx="5" fill="'+pcClr+'"/>';
  s+=tx(pbX+pbW/2,pbY-5,(prog*100).toFixed(1)+'%'+(d.xs>r.xW+.005?' ‚Äî En cours':' ‚Äî Termin√©'),9,{c:pcClr,b:true});

  // ========= DATA PANEL (glassmorphism) =========
  var dpX=650,dpY=390,dpW=510,dpH=280;
  s+='<rect x="'+dpX+'" y="'+dpY+'" width="'+dpW+'" height="'+dpH+'" rx="10" fill="'+WH+'" stroke="#cfd8dc" stroke-width="1" filter="url(#sh)" opacity=".97"/>';
  s+=tx(dpX+dpW/2,dpY+22,'BILAN INSTANTAN√â',11,{b:true});
  s+=ln(dpX+20,dpY+30,dpX+dpW-20,dpY+30,'#eceff1',1.5);
  var items=[
    ['T bouilleur',d.Tb.toFixed(1)+'¬∞C',liqDk],['T t√™te',d.Tt.toFixed(1)+'¬∞C','#1976d2'],['ŒîT',Math.abs(d.Tb-d.Tt).toFixed(1)+'¬∞C',GR],
    ['x bouilleur',d.xs.toFixed(4),liqDk],['y vapeur',d.yv.toFixed(4),vapClr],['xD distillat',d.xDi.toFixed(4),dstClr],
    ['Reflux R',d.Ra.toFixed(2),rfxClr],['D√©bit D',d.Dr.toFixed(2)+' kg/h',dstClr],['Vol. distillat',d.Dv.toFixed(1)+' L',dstClr],
    ['Q reboiler',d.Qr.toFixed(1)+' kW',stmClr],['Q condenseur',d.Qc.toFixed(1)+' kW',cwClr],['Temps',d.t.toFixed(0)+' min',BK]
  ];
  for(var k=0;k<items.length;k++){
    var col=k%3,row=Math.floor(k/3);
    var ix=dpX+22+col*168,iy=dpY+50+row*58;
    s+=tx(ix,iy,items[k][0],8,{a:'start',c:GR});
    s+=tx(ix,iy+20,items[k][1],13,{a:'start',c:items[k][2],b:true});
  }

  // ========= LEGEND =========
  var lgY=dpY+dpH+12;
  s+='<rect x="'+dpX+'" y="'+lgY+'" width="'+dpW+'" height="36" rx="6" fill="#f5f5f5" stroke="#e0e0e0" stroke-width=".8"/>';
  s+=ln(dpX+15,lgY+18,dpX+38,lgY+18,BK,2.5);s+=tx(dpX+44,lgY+22,'Process',7,{a:'start',c:GR});
  s+=ln(dpX+108,lgY+18,dpX+131,lgY+18,vapClr,2,'stroke-dasharray="10,5"');s+=tx(dpX+137,lgY+22,'Vapeur',7,{a:'start',c:GR});
  s+=ln(dpX+200,lgY+18,dpX+223,lgY+18,rfxClr,2,'stroke-dasharray="8,4"');s+=tx(dpX+229,lgY+22,'Reflux',7,{a:'start',c:GR});
  s+=ln(dpX+292,lgY+18,dpX+315,lgY+18,dstClr,2,'stroke-dasharray="8,4"');s+=tx(dpX+321,lgY+22,'Distillat',7,{a:'start',c:GR});
  s+=ln(dpX+398,lgY+18,dpX+421,lgY+18,LG,1.5,'stroke-dasharray="6,3"');s+=tx(dpX+427,lgY+22,'Utilit√©',7,{a:'start',c:GR});

  // ========= TITLE BLOCK =========
  s+='<rect x="3" y="730" width="1194" height="48" fill="#f0f0f0" stroke="#bdbdbd" stroke-width="1" rx="0 0 3 3"/>';
  s+=ln(600,730,600,778,'#bdbdbd',.8)+ln(940,730,940,778,'#bdbdbd',.8);
  s+=tx(300,748,'PFD ‚Äî DISTILLATION BATCH',12,{b:true});
  s+=tx(300,762,r.l.n+' / '+r.h.n+' ‚Äî '+r.model.toUpperCase()+' ‚Äî '+(r.P/1000).toFixed(2)+' bar',8.5,{c:GR});
  s+=tx(770,748,'DistillAI v2',10,{b:true})+tx(770,762,'ISO 10628',8,{c:GR});
  s+=tx(1060,748,'R√©v. 0',9,{b:true})+tx(1060,762,new Date().toLocaleDateString('fr-FR'),8,{c:GR});

  svg.innerHTML=s;
  document.getElementById('aMet').innerHTML=rc(d.xs.toFixed(4),'x bouilleur','')+rc(d.yv.toFixed(4),'y vapeur','')+rc(d.Tb.toFixed(1),'T¬∞ pied','¬∞C')+rc(d.Tt.toFixed(1),'T¬∞ t√™te','¬∞C')+rc(d.Dv.toFixed(1),'Vol. dist.','L')+rc(d.Dr.toFixed(2),'D√©bit dist.','kg/h');
}

function toggleAnim(){
  playing=!playing;document.getElementById('btnPP').textContent=playing?'\u23f8 Pause':'\u25b6 D\u00e9marrer';
  if(playing)runAnim();else cancelAnimationFrame(animId);
}
function runAnim(){
  if(!playing)return;const sl=document.getElementById('tSlider');
  sl.value=Math.min(+sl.value+animSpd*.3,100);drawAnim(+sl.value);
  if(+sl.value>=100){playing=false;document.getElementById('btnPP').textContent='\u25b6 D\u00e9marrer';return;}
  animId=requestAnimationFrame(runAnim);
}

// ===== REPORT =====
function genReport(){const r=R_;
  const matN={ss316:'Inox 316L',ss304:'Inox 304',hastelloy:'Hastelloy C-276',glass:'Verre borosilicat√©',ptfe:'Rev√™tement PTFE'}[r.mat]||r.mat;
  const intN={sieve:'Plateaux perfor√©s',valve:'Plateaux √† clapets',structured:'Garnissage structur√©',random:'Garnissage en vrac'}[r.intType]||r.intType;
  const mTag=r.model==='nrtl'?'NRTL (non-id√©al)':'Raoult (id√©al)';
  const azeoTxt=r.azeos.length?'<div class="wb">‚ö†Ô∏è Az√©otrope d√©tect√© : '+r.azeos.map(a=>'x‚ÇÅ='+a.x.toFixed(3)+', T='+a.T.toFixed(1)+'¬∞C').join('; ')+'</div>':'';
  document.getElementById('repC').innerHTML=
    '<div style="text-align:center;padding:1.5rem 0"><h1 style="font-family:Playfair Display,serif;font-size:1.8rem;color:var(--acc)">Rapport de Dimensionnement</h1>'+
    '<p style="color:var(--t2);margin-top:.5rem">DistillAI v2 ‚Äî '+new Date().toLocaleDateString('fr-FR')+'</p></div>'+
    '<div class="rs"><h3>1. Syst√®me √©tudi√©</h3><p>Compos√© l√©ger : <strong>'+r.l.n+'</strong> ('+r.l.f+', Tb='+r.l.tb+'¬∞C, MW='+r.l.mw+' g/mol)<br>'+
    'Compos√© lourd : <strong>'+r.h.n+'</strong> ('+r.h.f+', Tb='+r.h.tb+'¬∞C, MW='+r.h.mw+' g/mol)<br>'+
    'Mod√®le thermodynamique : <strong>'+mTag+'</strong><br>'+
    'Volatilit√© relative moyenne Œ± = '+r.alpha.toFixed(3)+'</p>'+azeoTxt+'</div>'+
    '<div class="rs"><h3>2. Sp√©cifications</h3><p>Volume de charge : '+r.vF+' L ('+r.mF.toFixed(1)+' kg, '+r.nF.toFixed(0)+' mol)<br>'+
    'Composition : xF = '+r.xF+' | xD = '+r.xD+' | xW = '+r.xW+'<br>'+
    'Pression : '+r.P+' kPa | Internes : '+intN+' | Mat√©riau : '+matN+'</p></div>'+
    '<div class="rs"><h3>3. R√©sultats du dimensionnement</h3>'+
    '<table class="rt"><tr><th>Param√®tre</th><th>Valeur</th><th>Unit√©</th></tr>'+
    '<tr><td>Nmin (Fenske)</td><td>'+r.Nmin.toFixed(2)+'</td><td>‚Äî</td></tr>'+
    '<tr><td>Rmin (VLE pinch)</td><td>'+r.Rmin.toFixed(3)+'</td><td>‚Äî</td></tr>'+
    '<tr><td>R op√©ratoire</td><td>'+r.R.toFixed(3)+'</td><td>‚Äî</td></tr>'+
    '<tr><td>N th√©oriques</td><td>'+Math.ceil(r.Nth)+'</td><td>‚Äî</td></tr>'+
    '<tr><td>N r√©els (Œ∑='+r.eta+')</td><td>'+r.Nact+'</td><td>‚Äî</td></tr>'+
    '<tr><td>Diam√®tre</td><td>'+(r.Dstd*1000).toFixed(0)+'</td><td>mm</td></tr>'+
    '<tr><td>Hauteur garnissage</td><td>'+r.Hpack.toFixed(2)+'</td><td>m</td></tr>'+
    '<tr><td>Hauteur totale</td><td>'+r.Htot.toFixed(2)+'</td><td>m</td></tr>'+
    '<tr><td>HETP</td><td>'+(r.hetp*100).toFixed(0)+'</td><td>cm</td></tr>'+
    '<tr><td>ŒîP colonne</td><td>'+r.dPtot.toFixed(2)+'</td><td>kPa</td></tr>'+
    '</table></div>'+
    '<div class="rs"><h3>4. Bilan thermique</h3>'+
    '<table class="rt"><tr><th>Param√®tre</th><th>Valeur</th><th>Unit√©</th></tr>'+
    '<tr><td>Q sensible (chauffage)</td><td>'+(r.Qsen/1000).toFixed(1)+'</td><td>MJ</td></tr>'+
    '<tr><td>Q vaporisation</td><td>'+(r.Qvap/1000).toFixed(1)+'</td><td>MJ</td></tr>'+
    '<tr><td>Q total batch</td><td>'+(r.Qtot/1000).toFixed(1)+'</td><td>MJ</td></tr>'+
    '<tr><td>Puissance bouilleur</td><td>'+r.Qreb.toFixed(2)+'</td><td>kW</td></tr>'+
    '<tr><td>Puissance condenseur</td><td>'+r.Qcond.toFixed(2)+'</td><td>kW</td></tr>'+
    '<tr><td>T¬∞ t√™te</td><td>'+r.Ttop.toFixed(1)+'</td><td>¬∞C</td></tr>'+
    '<tr><td>T¬∞ pied</td><td>'+r.Tbot.toFixed(1)+'</td><td>¬∞C</td></tr>'+
    '</table></div>'+
    '<div class="rs"><h3>5. Bilan mati√®re</h3>'+
    '<table class="rt"><tr><th>Flux</th><th>Masse (kg)</th><th>Volume (L)</th><th>Composition</th></tr>'+
    '<tr><td>Charge</td><td>'+r.mF.toFixed(1)+'</td><td>'+r.vF+'</td><td>xF = '+r.xF+'</td></tr>'+
    '<tr><td>Distillat</td><td>'+r.mD.toFixed(1)+'</td><td>'+r.vD.toFixed(1)+'</td><td>xD = '+r.xD+'</td></tr>'+
    '<tr><td>R√©sidu</td><td>'+r.mW.toFixed(1)+'</td><td>‚Äî</td><td>xW = '+r.xW+'</td></tr>'+
    '</table></div>'+
    '<div class="rs"><h3>6. Utilit√©s</h3><p>'+
    'Vapeur 3 bar ('+r.stT+'¬∞C) : '+r.stFlow.toFixed(1)+' kg/h<br>'+
    'Eau refroidissement ('+r.cwIn+'‚Üí'+r.cwOut+'¬∞C) : '+r.cwFlow.toFixed(0)+' kg/h<br>'+
    'Surface condenseur : '+r.Acond.toFixed(2)+' m¬≤ | Surface bouilleur : '+r.Areb.toFixed(2)+' m¬≤<br>'+
    'Dur√©e estim√©e du batch : '+(r.tBatch*60).toFixed(0)+' min</p></div>'+
    '<div class="rs"><h3>7. S√©curit√© & Recommandations</h3>'+
    '<p>Dangers identifi√©s : '+r.allH.join(', ')+'</p>'+
    r.saf.map(s=>'<p style="padding:.2rem 0">'+s+'</p>').join('')+
    '</div>'+
    '<div class="rs"><h3>8. Hypoth√®ses & Limites</h3><p>'+
    'Mod√®le '+mTag+' ‚Äî '+(r.model==='nrtl'?'coefficients d\'activit√© NRTL avec param√®tres DECHEMA':'loi de Raoult, validit√© limit√©e aux m√©langes quasi-id√©aux')+'.<br>'+
    'Shortcut Fenske-Underwood-Gilliland. Pertes thermiques n√©glig√©es. Pression constante. Holdup colonne n√©glig√©.<br>'+
    '<strong>Ces r√©sultats constituent un avant-projet et doivent √™tre valid√©s par simulation rigoureuse.</strong></p></div>'+
    '<div style="text-align:center;padding:1rem;color:var(--t3);font-size:.8rem;border-top:1px solid var(--brd);margin-top:1.5rem">'+
    'G√©n√©r√© par DistillAI v2 ‚Äî ¬© Alysophil SAS '+new Date().getFullYear()+' ‚Äî Sources: NIST, Perry\'s 9th ed., DECHEMA VLE Data Series</div>';
}

function dlReport(){
  const html='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Rapport DistillAI v2</title><style>body{font-family:Arial,sans-serif;max-width:900px;margin:0 auto;padding:2rem;color:#333}h1{color:#d97706;text-align:center}h3{color:#1e40af;border-bottom:2px solid #f59e0b;padding-bottom:.3rem}table{width:100%;border-collapse:collapse;margin:1rem 0}th,td{padding:.5rem;border:1px solid #ddd;text-align:left}th{background:#f8fafc;color:#1e40af}.warn{background:#fffbeb;border:1px solid #f59e0b;padding:.8rem;border-radius:5px;margin:.8rem 0}.info{background:#eff6ff;border:1px solid #3b82f6;padding:.8rem;border-radius:5px;margin:.8rem 0}</style></head><body>'+document.getElementById('repC').innerHTML+'</body></html>';
  const b=new Blob([html],{type:'text/html'}),a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='Rapport_DistillAI_v2.html';a.click();
}
</script>
</body>
</html>
